<!-- sooratvaziat\templates\detailed_session.html -->
<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>جزئیات صورت جلسه - {{ session.session_number }}</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

    <style>
        body {
            font-family: 'Tahoma', 'Arial', sans-serif;
            direction: rtl;
            background-color: #f8f9fa;
            line-height: 1.6;
        }
        .header-section {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 2rem 0;
            border-radius: 10px;
            margin-bottom: 2rem;
        }
        .session-info {
            background: white;
            border-radius: 10px;
            padding: 1.5rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            margin-bottom: 2rem;
            border-right: 5px solid #3498db;
        }
        .project-info {
            background: linear-gradient(135deg, #8e44ad, #9b59b6);
            color: white;
            border-radius: 10px;
            padding: 1rem;
            margin-bottom: 1.5rem;
        }
        .form-control {
            border-radius: 8px;
            padding: 8px 12px;
        }
        .table th {
            background-color: #3498db;
            color: white;
            font-weight: bold;
            text-align: center;
            vertical-align: middle;
        }
        .table td {
            text-align: center;
            vertical-align: middle;
        }
        .btn-action {
            border-radius: 25px;
            padding: 8px 20px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .btn-action:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        .delete-btn {
            background-color: #e74c3c;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            transition: all 0.3s ease;
        }
        .delete-btn:hover {
            background-color: #c0392b;
            transform: translateY(-1px);
        }
        [id^="id_items-"][id$="-DELETE"] {
            display: none;
        }
        .hidden-input {
            display: none;
        }
        .total-section {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
            padding: 1rem;
            border-radius: 10px;
            margin: 1rem 0;
            text-align: center;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .action-buttons {
            margin-top: 2rem;
            padding: 1.5rem;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .empty-row-message {
            text-align: center;
            padding: 2rem;
            color: #6c757d;
            font-style: italic;
        }
        .action-cell {
            min-width: 120px;
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <!-- Header Section -->
        <div class="header-section text-center">
            <h1 class="display-6 fw-bold mb-3">
                <i class="fas fa-clipboard-list me-2"></i>
                جزئیات صورت‌جلسه
            </h1>
            <p class="lead mb-0">شماره صورت‌جلسه: {{ session.session_number }}</p>
        </div>

        <!-- Project Information -->
        {% if project %}
        <div class="project-info">
            <div class="row">
                <div class="col-md-6">
                    <h5 class="mb-2">
                        <i class="fas fa-project-diagram me-2"></i>
                        {{ project.project_name }}
                    </h5>
                    <p class="mb-1"><strong>کد پروژه:</strong> {{ project.project_code }}</p>
                    <p class="mb-1"><strong>سال اجرا:</strong> {{ project.execution_year }}</p>
                </div>
                <div class="col-md-6">
                    <p class="mb-1"><strong>کارفرما:</strong> {{ project.employer|default:"-" }}</p>
                    <p class="mb-1"><strong>پیمانکار:</strong> {{ project.contractor|default:"-" }}</p>
                    <p class="mb-0"><strong>محل پروژه:</strong> {{ project.city|default:"-" }} - {{ project.province|default:"-" }}</p>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Session Information -->
        <div class="session-info">
            <div class="row">
                <div class="col-md-6">
                    <h5 class="text-primary mb-3">
                        <i class="fas fa-info-circle me-2"></i>
                        اطلاعات صورت جلسه
                    </h5>
                    <form method="post" id="item-form">
                        {% csrf_token %}
                        {{ session_form.media }}

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_session_date" class="form-label">تاریخ صورت جلسه:</label>
                                    {{ session_form.session_date }}
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label for="id_discipline_choice" class="form-label">رشته:</label>
                                    {{ session_form.discipline_choice }}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Total Quantity -->
            <div class="total-section">
                <h4 class="mb-0">
                    <i class="fas fa-calculator me-2"></i>
                    مجموع کل: {{ total_quantity }}
                </h4>
            </div>

            <!-- Items Table -->
            <div class="table-responsive">
                <table class="table table-striped table-hover" id="item-table">
                    <thead>
                        <tr>
                            <th width="15%">آیتم فهرست‌بها</th>
                            <th width="20%">توضیح ردیف</th>
                            <th width="10%">طول</th>
                            <th width="10%">عرض</th>
                            <th width="10%">ارتفاع</th>
                            <th width="10%">وزن</th>
                            <th width="10%">تعداد</th>
                            <th width="15%">عملیات</th>
                        </tr>
                    </thead>
                    <tbody>
                        {{ formset.management_form }}
                        {% for form in formset %}
                        <tr class="item-row">
                            <td>{{ form.pricelist_item }}</td>
                            <td>{{ form.row_description }}</td>
                            <td>{{ form.length }}</td>
                            <td>{{ form.width }}</td>
                            <td>{{ form.height }}</td>
                            <td>{{ form.weight }}</td>
                            <td>{{ form.count }}</td>
                            <td class="action-cell">
                                <div class="d-flex flex-column align-items-center gap-2">
                                    <button type="button" class="btn delete-btn w-100">
                                        <i class="fas fa-trash ms-1"></i>حذف
                                    </button>
                                    <div class="hidden-inputs">
                                        {{ form.id }}
                                        {{ form.DELETE }}
                                    </div>
                                </div>
                                {% if form.errors %}
                                <div class="text-danger small mt-2">
                                    {% for error in form.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% empty %}
                        <tr>
                            <td colspan="8" class="empty-row-message">
                                <i class="fas fa-exclamation-circle me-2"></i>
                                هیچ آیتمی برای این صورت جلسه ثبت نشده است.
                            </td>
                        </tr>
                        {% endfor %}
                        
                        <!-- Empty Row Template -->
                        <tr id="empty-row" class="item-row" style="display:none;">
                            <td>{{ formset.empty_form.pricelist_item }}</td>
                            <td>{{ formset.empty_form.row_description }}</td>
                            <td>{{ formset.empty_form.length }}</td>
                            <td>{{ formset.empty_form.width }}</td>
                            <td>{{ formset.empty_form.height }}</td>
                            <td>{{ formset.empty_form.weight }}</td>
                            <td>{{ formset.empty_form.count }}</td>
                            <td style="background-color: white;">
                                <button type="button" class="btn delete-row">
                                    <i class="fas fa-trash me-1"></i>حذف
                                </button>
                                {{ formset.empty_form.id }} 
                                {{ formset.empty_form.DELETE }}
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Action Buttons -->
            <div class="action-buttons">
                <div class="row">
                    <div class="col-md-6">
                        <button type="button" class="btn btn-success btn-action w-100" id="add-row">
                            <i class="fas fa-plus-circle me-2"></i>افزودن ردیف جدید
                        </button>
                    </div>
                    <div class="col-md-6">
                        <button type="submit" class="btn btn-primary btn-action w-100">
                            <i class="fas fa-save me-2"></i>ذخیره تغییرات
                        </button>
                    </div>
                </div>
            </div>
        </form>

        <!-- Navigation Buttons -->
        <div class="row mt-4">
            <div class="col-md-4">
                {% if project %}
                <a href="{% url 'session_list' project.id %}" class="btn btn-secondary btn-action w-100">
                    <i class="fas fa-arrow-right me-2"></i>بازگشت به لیست
                </a>
                {% else %}
                <a href="{% url 'project_financial_report_list' %}" class="btn btn-secondary btn-action w-100">
                    <i class="fas fa-arrow-right me-2"></i>بازگشت به پروژه‌ها
                </a>
                {% endif %}
            </div>
            <div class="col-md-4">
                {% if project %}
                <a href="{% url 'riz_metre_discipline_list' project.id %}" class="btn btn-info btn-action w-100">
                    <i class="fas fa-ruler-combined me-2"></i>ریز متره
                </a>
                {% endif %}
            </div>
            <div class="col-md-4">
                {% if project %}
                <a href="{% url 'riz_financial_discipline_list' project.id %}" class="btn btn-warning btn-action w-100">
                    <i class="fas fa-calculator me-2"></i>ریز مالی
                </a>
                {% endif %}
            </div>
        </div>

        <!-- Footer -->
        <div class="text-center text-muted mt-5 pt-3">
            <p class="small">
                <i class="fas fa-clock me-1"></i>
                تاریخ امروز: {% now "Y/m/d" %}
                {% if project %}
                | 
                <i class="fas fa-project-diagram me-1"></i>
                پروژه: {{ project.project_name }}
                {% endif %}
            </p>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // ---------- Formset JS ----------
        document.addEventListener('DOMContentLoaded', function() {
            const tableBody = document.querySelector('#item-table tbody');
            const emptyRow = document.querySelector('#empty-row');
            const addButton = document.querySelector('#add-row');
            const prefix = '{{ formset.prefix }}';

            function updateFormIndexes() {
                const rows = tableBody.querySelectorAll('.item-row:not(#empty-row)');
                rows.forEach((row, index) => {
                    row.querySelectorAll('input, select, textarea').forEach(input => {
                        if (input.name) {
                            input.name = input.name.replace(new RegExp(`${prefix}-\\d+-`), `${prefix}-${index}-`);
                        }
                        if (input.id) {
                            input.id = input.id.replace(new RegExp(`${prefix}-\\d+-`), `${prefix}-${index}-`);
                        }
                    });
                });
                document.querySelector(`[name="${prefix}-TOTAL_FORMS"]`).value = rows.length;
            }

            addButton.addEventListener('click', function() {
                const totalForms = parseInt(document.querySelector(`[name="${prefix}-TOTAL_FORMS"]`).value);
                const newRow = emptyRow.cloneNode(true);
                newRow.style.display = '';
                newRow.innerHTML = newRow.innerHTML.replace(/__prefix__/g, totalForms);
                tableBody.insertBefore(newRow, emptyRow);
                
                // Add Bootstrap classes to new form elements
                newRow.querySelectorAll('input, select, textarea').forEach(element => {
                    element.classList.add('form-control');
                });
                
                updateFormIndexes();
            });

            tableBody.addEventListener('click', function(event) {
                if (event.target.classList.contains('delete-row') || 
                    event.target.closest('.delete-row')) {
                    const deleteBtn = event.target.classList.contains('delete-row') ? 
                        event.target : event.target.closest('.delete-row');
                    const row = deleteBtn.closest('.item-row');
                    const deleteInput = row.querySelector('input[name$="-DELETE"]');
                    const idInput = row.querySelector('input[name$="-id"]');
                    
                    if (idInput && idInput.value) {
                        deleteInput.checked = true;
                        row.style.display = 'none';
                    } else {
                        row.remove();
                    }
                    updateFormIndexes();
                }
            });

            // Initialize form controls with Bootstrap classes
            document.querySelectorAll('#item-table input, #item-table select, #item-table textarea').forEach(element => {
                element.classList.add('form-control');
            });

            // Add loading animation to submit button
            const submitButton = document.querySelector('button[type="submit"]');
            if (submitButton) {
                submitButton.addEventListener('click', function() {
                    const originalText = this.innerHTML;
                    this.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>در حال ذخیره...';
                    this.disabled = true;
                    
                    setTimeout(() => {
                        this.innerHTML = originalText;
                        this.disabled = false;
                    }, 3000);
                });
            }
        });

        // ---------- Datepicker (if needed) ----------
        $(function () {
            // If you're using Persian Datepicker, initialize it here
            if (typeof $.fn.persianDatepicker !== 'undefined') {
                $(".persian-datepicker").persianDatepicker({
                    format: 'YYYY/MM/DD',
                    timePicker: { enabled: true },
                    initialValueType: 'gregorian',
                    autoClose: true
                });
            }
        });
    </script>
</body>
</html>