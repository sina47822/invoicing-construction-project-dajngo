<!-- templates/account/manage_roles.html -->
{% extends 'layout/profile_base.html' %}

{% load static %}

{% block title %}مدیریت نقش‌های کاربران{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- Messages -->
    {% if messages %}
    <div class="row mb-4">
        <div class="col-12">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                <i class="bi {% if message.tags == 'success' %}bi-check-circle text-success{% elif message.tags == 'error' %}bi-exclamation-triangle text-danger{% elif message.tags == 'warning' %}bi-exclamation-triangle text-warning{% else %}bi-info-circle text-info{% endif %} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb" class="d-none d-md-block">
                <ol class="breadcrumb breadcrumb-light">
                    <li class="breadcrumb-item">
                        <a href="{% url 'accounts:user_list' %}">
                            <i class="bi bi-people me-1"></i>کاربران
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">مدیریت نقش‌ها</li>
                </ol>
            </nav>
            <h2 class="mb-1">
                <i class="bi bi-person-gear text-primary me-2"></i>
                مدیریت نقش‌های کاربر
            </h2>
            <p class="text-muted mb-0">
                <small>مدیریت نقش‌های کاربر: {{ target_user.get_full_name|default:target_user.username }}</small>
            </p>
        </div>
        
        <div class="d-flex gap-2">
            <a href="{% url 'accounts:user_list' %}" 
               class="btn btn-outline-secondary">
                <i class="bi bi-arrow-right me-2"></i>بازگشت به لیست کاربران
            </a>
        </div>
    </div>

    <!-- اطلاعات کاربر -->
    <div class="row">
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light border-0">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-person-badge me-2"></i>
                        اطلاعات کاربر
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <th width="40%">نام کاربری:</th>
                                    <td>{{ target_user.username }}</td>
                                </tr>
                                <tr>
                                    <th>نام کامل:</th>
                                    <td>{{ target_user.get_full_name|default:"-" }}</td>
                                </tr>
                                <tr>
                                    <th>ایمیل:</th>
                                    <td>{{ target_user.email|default:"-" }}</td>
                                </tr>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <table class="table table-borderless">
                                <tr>
                                    <th width="40%">وضعیت:</th>
                                    <td>
                                        {% if target_user.is_active %}
                                            <span class="badge bg-success">فعال</span>
                                        {% else %}
                                            <span class="badge bg-danger">غیرفعال</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>سوپر کاربر:</th>
                                    <td>
                                        {% if target_user.is_superuser %}
                                            <span class="badge bg-warning">بله</span>
                                        {% else %}
                                            <span class="badge bg-secondary">خیر</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                <tr>
                                    <th>تاریخ عضویت:</th>
                                    <td>{{ target_user.date_joined|date:"Y/m/d H:i" }}</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- مدیریت نقش‌ها -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-0">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-shield-check me-2"></i>
                        مدیریت نقش‌ها
                    </h5>
                </div>
                <div class="card-body">
                    <!-- نقش‌های فعلی -->
                    <div class="mb-4">
                        <h6 class="text-primary mb-3">
                            <i class="bi bi-list-check me-2"></i>
                            نقش‌های فعلی کاربر
                        </h6>
                        
                        {% if user_roles %}
                            <div class="table-responsive">
                                <table class="table table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th>نقش</th>
                                            <th>وضعیت</th>
                                            <th>تاریخ ایجاد</th>
                                            <th>عملیات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for user_role in user_roles %}
                                        <tr>
                                            <td>
                                                <span class="fw-semibold">{{ user_role.get_role_display }}</span>
                                                <br>
                                                <small class="text-muted">{{ user_role.role }}</small>
                                            </td>
                                            <td>
                                                {% if user_role.is_active %}
                                                    <span class="badge bg-success">فعال</span>
                                                {% else %}
                                                    <span class="badge bg-secondary">غیرفعال</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <small class="text-muted">{{ user_role.created_at|date:"Y/m/d" }}</small>
                                            </td>
                                            <td>
                                                <div class="btn-group btn-group-sm">
                                                    {% if user_role.is_active %}
                                                        <form method="post" action="{% url 'accounts:deactivate_role' target_user.id user_role.id %}" class="d-inline">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-outline-warning btn-sm" 
                                                                    onclick="return confirm('آیا از غیرفعال کردن این نقش مطمئن هستید؟')">
                                                                <i class="bi bi-pause-circle me-1"></i>غیرفعال
                                                            </button>
                                                        </form>
                                                    {% else %}
                                                        <form method="post" action="{% url 'accounts:activate_role' target_user.id user_role.id %}" class="d-inline">
                                                            {% csrf_token %}
                                                            <button type="submit" class="btn btn-outline-success btn-sm">
                                                                <i class="bi bi-play-circle me-1"></i>فعال
                                                            </button>
                                                        </form>
                                                    {% endif %}
                                                    <form method="post" action="{% url 'accounts:delete_role' target_user.id user_role.id %}" class="d-inline">
                                                        {% csrf_token %}
                                                        <button type="submit" class="btn btn-outline-danger btn-sm" 
                                                                onclick="return confirm('آیا از حذف این نقش مطمئن هستید؟')">
                                                            <i class="bi bi-trash me-1"></i>حذف
                                                        </button>
                                                    </form>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        {% else %}
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle me-2"></i>
                                این کاربر هیچ نقشی ندارد.
                            </div>
                        {% endif %}
                    </div>

                    <!-- افزودن نقش جدید -->
                    <div class="border-top pt-4">
                        <h6 class="text-success mb-3">
                            <i class="bi bi-plus-circle me-2"></i>
                            افزودن نقش جدید
                        </h6>
                        
                        <form method="post" action="{% url 'accounts:add_role' target_user.id %}">
                            {% csrf_token %}
                            <div class="row g-3 align-items-end">
                                <div class="col-md-6">
                                    <label for="role" class="form-label">نقش جدید</label>
                                    <select name="role" id="role" class="form-select" required>
                                        <option value="">انتخاب نقش</option>
                                        <option value="contractor">پیمانکار</option>
                                        <option value="project_manager">مدیر طرح</option>
                                        <option value="employer">کارفرما</option>
                                        <option value="admin">ادمین</option>
                                        <option value="supervisor">ناظر</option>
                                        <option value="engineer">مهندس</option>
                                        <option value="consultant">مشاور</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" name="is_active" id="is_active" checked>
                                        <label class="form-check-label" for="is_active">
                                            نقش فعال باشد
                                        </label>
                                    </div>
                                </div>
                                <div class="col-md-2">
                                    <button type="submit" class="btn btn-success w-100">
                                        <i class="bi bi-plus-circle me-1"></i>افزودن
                                    </button>
                                </div>
                            </div>
                            <div class="form-text mt-2">
                                نقش انتخاب شده به لیست نقش‌های کاربر اضافه خواهد شد.
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- اطلاعات آماری -->
        <div class="col-lg-4">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light border-0">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-graph-up me-2"></i>
                        آمار نقش‌ها
                    </h5>
                </div>
                <div class="card-body">
                    <div class="text-center mb-4">
                        <div class="display-6 text-primary fw-bold">{{ user_roles|length }}</div>
                        <div class="text-muted">تعداد نقش‌ها</div>
                    </div>
                    
                    <div class="mb-3">
                        <div class="d-flex justify-content-between mb-2">
                            <span>نقش‌های فعال:</span>
                            <span class="fw-semibold">
                                {{ user_roles|length }} از {{ user_roles|length }}
                            </span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div class="progress-bar bg-success" style="width: 100%"></div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h6 class="text-muted mb-3">دسترسی‌های مهم:</h6>
                        <ul class="list-unstyled">
                            <li class="mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                ایجاد کاربر جدید
                                <span class="badge bg-light text-dark ms-2">ادمین/پیمانکار</span>
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                مدیریت پروژه‌ها
                                <span class="badge bg-light text-dark ms-2">مدیر طرح</span>
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                مشاهده گزارشات مالی
                                <span class="badge bg-light text-dark ms-2">کارفرما</span>
                            </li>
                            <li class="mb-2">
                                <i class="bi bi-check-circle text-success me-2"></i>
                                تایید متره‌ها
                                <span class="badge bg-light text-dark ms-2">ناظر</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

            <!-- راهنما -->
            <div class="card border-0 shadow-sm">
                <div class="card-header bg-light border-0">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-question-circle me-2"></i>
                        راهنمای نقش‌ها
                    </h5>
                </div>
                <div class="card-body">
                    <div class="accordion" id="rolesHelp">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#help1">
                                    پیمانکار
                                </button>
                            </h2>
                            <div id="help1" class="accordion-collapse collapse show" data-bs-parent="#rolesHelp">
                                <div class="accordion-body">
                                    می‌تواند پروژه ایجاد کند، کاربران جدید اضافه کند و متره‌ها را مدیریت کند.
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#help2">
                                    مدیر طرح
                                </button>
                            </h2>
                            <div id="help2" class="accordion-collapse collapse" data-bs-parent="#rolesHelp">
                                <div class="accordion-body">
                                    مدیریت کلی پروژه، تایید متره‌ها و نظارت بر پیشرفت کار.
                                </div>
                            </div>
                        </div>
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#help3">
                                    کارفرما
                                </button>
                            </h2>
                            <div id="help3" class="accordion-collapse collapse" data-bs-parent="#rolesHelp">
                                <div class="accordion-body">
                                    مشاهده گزارشات، تایید پرداخت‌ها و نظارت کلی بر پروژه.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.accordion-button:not(.collapsed) {
    background-color: #f8f9fa;
    color: #0d6efd;
}
.table th {
    font-weight: 600;
    color: #495057;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // مدیریت accordion
    const accordionItems = document.querySelectorAll('.accordion-button');
    accordionItems.forEach(button => {
        button.addEventListener('click', function() {
            const target = document.querySelector(this.getAttribute('data-bs-target'));
            if (target.classList.contains('show')) {
                this.querySelector('i').classList.replace('bi-chevron-up', 'bi-chevron-down');
            } else {
                this.querySelector('i').classList.replace('bi-chevron-down', 'bi-chevron-up');
            }
        });
    });

    // نمایش تأییدیه برای عملیات حذف
    const deleteForms = document.querySelectorAll('form[action*="delete"]');
    deleteForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            if (!confirm('آیا از حذف این نقش مطمئن هستید؟ این عمل قابل بازگشت نیست.')) {
                e.preventDefault();
            }
        });
    });

    // نمایش تأییدیه برای غیرفعال کردن نقش
    const deactivateForms = document.querySelectorAll('form[action*="deactivate"]');
    deactivateForms.forEach(form => {
        form.addEventListener('submit', function(e) {
            if (!confirm('آیا از غیرفعال کردن این نقش مطمئن هستید؟ کاربر دسترسی‌های مربوط به این نقش را از دست خواهد داد.')) {
                e.preventDefault();
            }
        });
    });

    console.log('✅ Roles management page initialized');
});
</script>
{% endblock %}