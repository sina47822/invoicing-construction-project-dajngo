{% extends 'layout/project_base.html' %}
{% load humanize %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-edit me-2"></i>
                    {{ title }}
                </h5>
            </div>
            <div class="card-body">
                <form method="post" novalidate id="session-form">
                    {% csrf_token %}
                    
                    {% if form.non_field_errors %}
                    <div class="alert alert-danger">
                        {% for error in form.non_field_errors %}
                            {{ error }}
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.session_number.id_for_label }}" class="form-label">
                                    {{ form.session_number.label }}
                                </label>
                                {{ form.session_number }}
                                {% if form.session_number.errors %}
                                <div class="text-danger small">
                                    {% for error in form.session_number.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.session_date.id_for_label }}" class="form-label">
                                    {{ form.session_date.label }}
                                </label>
                                {{ form.session_date }}
                                {% if form.session_date.errors %}
                                <div class="text-danger small">
                                    {% for error in form.session_date.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÙÛŒÙ„Ø¯ Ø±Ø´ØªÙ‡ -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="{{ form.discipline_filter.id_for_label }}" class="form-label">
                                    {{ form.discipline_filter.label }}
                                </label>
                                {{ form.discipline_filter }}
                                {% if form.discipline_filter.errors %}
                                <div class="text-danger small">
                                    {% for error in form.discipline_filter.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- ÙÛŒÙ„Ø¯ ÙÙ‡Ø±Ø³Øª Ø¨Ù‡Ø§ -->
                    <div class="row">
                        <div class="col-md-12">
                            <div class="mb-3">
                                <label for="{{ form.price_list.id_for_label }}" class="form-label">
                                    {{ form.price_list.label }}
                                </label>
                                {{ form.price_list }}
                                {% if form.price_list.errors %}
                                <div class="text-danger small">
                                    {% for error in form.price_list.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                                <div class="form-text">Ø§Ø¨ØªØ¯Ø§ Ø±Ø´ØªÙ‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.status.id_for_label }}" class="form-label">
                                    {{ form.status.label }}
                                </label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                <div class="text-danger small">
                                    {% for error in form.status.errors %}
                                        {{ error }}
                                    {% endfor %}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label">
                            {{ form.description.label }}
                        </label>
                        {{ form.description }}
                        {% if form.description.errors %}
                        <div class="text-danger small">
                            {% for error in form.description.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        <label for="{{ form.notes.id_for_label }}" class="form-label">
                            {{ form.notes.label }}
                        </label>
                        {{ form.notes }}
                        {% if form.notes.errors %}
                        <div class="text-danger small">
                            {% for error in form.notes.errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                        {% endif %}
                    </div>
                    
                    <div class="d-flex justify-content-between align-items-center py-3 px-4 bg-light rounded border">
                        {% if session %}
                            <!-- Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´ - Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª session -->
                            <a href="{% url 'sooratvaziat:session_detail' project.pk session.pk %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-right me-1"></i>
                                Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª
                            </a>
                        {% else %}
                            <!-- Ø­Ø§Ù„Øª Ø§ÛŒØ¬Ø§Ø¯ Ø¬Ø¯ÛŒØ¯ - Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª sessions -->
                            <a href="{% url 'sooratvaziat:session_list' project.pk %}" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-right me-1"></i>
                                Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª ØµÙˆØ±Øª Ø¬Ù„Ø³Ø§Øª
                            </a>
                        {% endif %}
                        
                        <button type="submit" class="btn text-white" style="background-color: #0d6efd;">
                            <i class="fas fa-save me-1"></i>
                            {% if session %}Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ{% else %}Ø§ÛŒØ¬Ø§Ø¯ ØµÙˆØ±Øª Ø¬Ù„Ø³Ù‡{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const disciplineFilter = document.getElementById('{{ form.discipline_filter.id_for_label }}');
    const priceListSelect = document.getElementById('{{ form.price_list.id_for_label }}');
    const form = document.getElementById('session-form');
    
    console.log('=== FORM EDIT DEBUG INFO ===');
    console.log('Elements:', { 
        disciplineFilter, 
        priceListSelect,
        form
    });
    
    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯ Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙÙ‡Ø±Ø³Øª Ø¨Ù‡Ø§
    function logPriceListSelection() {
        if (priceListSelect && priceListSelect.value) {
            const selectedOption = priceListSelect.options[priceListSelect.selectedIndex];
            console.log('ğŸ“‹ ÙÙ‡Ø±Ø³Øª Ø¨Ù‡Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡:', {
                id: priceListSelect.value,
                text: selectedOption.text,
                fullElement: selectedOption
            });
        } else {
            console.log('âŒ Ù‡ÛŒÚ† ÙÙ‡Ø±Ø³Øª Ø¨Ù‡Ø§ÛŒÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª');
        }
    }
    
    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ù„Ø§Ú¯ Ú©Ø±Ø¯Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù…Ù„ ÙØ±Ù…
    function logFormData() {
        if (!form) return;
        
        const formData = new FormData(form);
        const formDataObj = {};
        
        for (let [key, value] of formData.entries()) {
            formDataObj[key] = value;
        }
        
        console.log('ğŸ“„ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ù…Ù„ ÙØ±Ù…:', formDataObj);
        console.log('ğŸ” Ù…Ù‚Ø§Ø¯ÛŒØ± Ù…Ù‡Ù…:');
        console.log('   - Ø±Ø´ØªÙ‡ (discipline_filter):', formDataObj['discipline_filter'] || 'ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡');
        console.log('   - ÙÙ‡Ø±Ø³Øª Ø¨Ù‡Ø§ (price_list):', formDataObj['price_list'] || 'ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡');
        console.log('   - Ø´Ù…Ø§Ø±Ù‡ ØµÙˆØ±Øª Ø¬Ù„Ø³Ù‡:', formDataObj['session_number'] || 'ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡');
        console.log('   - ÙˆØ¶Ø¹ÛŒØª:', formDataObj['status'] || 'ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡');
        
        return formDataObj;
    }
    
    // ØªØ§Ø¨Ø¹ Ø¨Ø±Ø§ÛŒ Ø¨Ù‡ Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙÙ‡Ø±Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ù‡Ø§
    function updatePriceLists(discipline) {
        if (!priceListSelect) {
            console.error('priceListSelect not found');
            return;
        }
        
        console.log('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ ÙÙ‡Ø±Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ù‡Ø§ Ø¨Ø±Ø§ÛŒ Ø±Ø´ØªÙ‡:', discipline);
        
        // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† options ÙØ¹Ù„ÛŒ
        priceListSelect.innerHTML = '<option value="">-- Ù„Ø·ÙØ§ Ù…Ù†ØªØ¸Ø± Ø¨Ù…Ø§Ù†ÛŒØ¯ --</option>';
        priceListSelect.disabled = true;
        
        if (discipline) {
            // Ø¯Ø±Ø®ÙˆØ§Ø³Øª AJAX Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª ÙÙ‡Ø±Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ù‡Ø§
            fetch(`/sooratvaziat/get-price-lists/?discipline=${discipline}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('âœ… Ø¯Ø±ÛŒØ§ÙØª ÙÙ‡Ø±Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ù‡Ø§:', data);
                    priceListSelect.innerHTML = '<option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ ÙÙ‡Ø±Ø³Øª Ø¨Ù‡Ø§ --</option>';
                    
                    if (data && data.length === 0) {
                        priceListSelect.innerHTML = '<option value="">-- ÙÙ‡Ø±Ø³Øª Ø¨Ù‡Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø±Ø´ØªÙ‡ ÛŒØ§ÙØª Ù†Ø´Ø¯ --</option>';
                        console.log('âš ï¸ Ù‡ÛŒÚ† ÙÙ‡Ø±Ø³Øª Ø¨Ù‡Ø§ÛŒÛŒ Ø¨Ø±Ø§ÛŒ Ø±Ø´ØªÙ‡', discipline, 'ÛŒØ§ÙØª Ù†Ø´Ø¯');
                    } else if (data) {
                        data.forEach(priceList => {
                            const option = document.createElement('option');
                            option.value = priceList.id;
                            // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø´ØªÙ‡ Ùˆ Ø³Ø§Ù„ Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´
                            const yearText = priceList.year ? `(${priceList.year})` : '';
                            option.textContent = `${priceList.discipline} ${yearText}`;
                            option.setAttribute('data-discipline', priceList.discipline_choice);
                            priceListSelect.appendChild(option);
                        });
                        console.log(`ğŸ“Š ${data.length} ÙÙ‡Ø±Ø³Øª Ø¨Ù‡Ø§ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯`);
                    }
                    
                    // Ø¯Ø± Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´ØŒ Ù…Ù‚Ø¯Ø§Ø± Ù‚Ø¨Ù„ÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†
                    {% if session.price_list %}
                        priceListSelect.value = "{{ session.price_list.pk }}";
                        console.log('âœï¸ Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´ - ÙÙ‡Ø±Ø³Øª Ø¨Ù‡Ø§ Ù‚Ø¨Ù„ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯:', "{{ session.price_list.pk }}");
                    {% endif %}
                    
                    priceListSelect.disabled = false;
                    
                    // Ù¾Ø³ Ø§Ø² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒØŒ Ø§Ú¯Ø± Ù…Ù‚Ø¯Ø§Ø±ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡ Ø¢Ù† Ø±Ø§ Ù„Ø§Ú¯ Ú©Ù†
                    setTimeout(() => {
                        if (priceListSelect.value) {
                            logPriceListSelection();
                        }
                    }, 100);
                })
                .catch(error => {
                    console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª ÙÙ‡Ø±Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ø¨Ù‡Ø§:', error);
                    priceListSelect.innerHTML = '<option value="">-- Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ --</option>';
                    priceListSelect.disabled = false;
                });
        } else {
            priceListSelect.innerHTML = '<option value="">-- Ø§Ø¨ØªØ¯Ø§ Ø±Ø´ØªÙ‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>';
            priceListSelect.disabled = true;
            console.log('â„¹ï¸ Ø±Ø´ØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª');
        }
    }
    
    // Ø±ÙˆÛŒØ¯Ø§Ø¯ ØªØºÛŒÛŒØ± ÙÙ‡Ø±Ø³Øª Ø¨Ù‡Ø§
    if (priceListSelect) {
        priceListSelect.addEventListener('change', function() {
            console.log('ğŸ”„ ØªØºÛŒÛŒØ± ÙÙ‡Ø±Ø³Øª Ø¨Ù‡Ø§ ØªØ´Ø®ÛŒØµ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯');
            logPriceListSelection();
        });
    }
    
    // Ù‡Ù†Ú¯Ø§Ù… ØªØºÛŒÛŒØ± Ø±Ø´ØªÙ‡
    if (disciplineFilter) {
        disciplineFilter.addEventListener('change', function() {
            const selectedValue = this.value;
            const selectedText = this.options[this.selectedIndex].text;
            console.log('ğŸ¯ Ø±Ø´ØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡:', {
                value: selectedValue,
                text: selectedText
            });
            updatePriceLists(selectedValue);
        });
        
        // Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ø±Ø§ ØªÙ†Ø¸ÛŒÙ… Ú©Ù†
        const initialFilterValue = disciplineFilter.value;
        console.log('ğŸ Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ø±Ø´ØªÙ‡:', initialFilterValue);
        if (initialFilterValue) {
            updatePriceLists(initialFilterValue);
        }
    } else {
        console.error('âŒ Ø§Ù„Ù…Ù†Øª Ø±Ø´ØªÙ‡ ÛŒØ§ÙØª Ù†Ø´Ø¯');
    }
    
    // Ø±ÙˆÛŒØ¯Ø§Ø¯ submit Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¨Ø§Ú¯
    if (form) {
        form.addEventListener('submit', function(e) {
            console.log('ğŸš€ === ÙØ±Ù… Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ø§Ø³Øª ===');
            
            // Ù„Ø§Ú¯ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ÙØ±Ù…
            const formData = logFormData();
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø§Ø¹ØªØ¨Ø§Ø± Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„
            const disciplineValue = formData['discipline_filter'];
            const priceListValue = formData['price_list'];
            
            console.log('ğŸ” Ø¨Ø±Ø±Ø³ÛŒ Ù†Ù‡Ø§ÛŒÛŒ Ù…Ù‚Ø§Ø¯ÛŒØ±:');
            console.log('   - Ø±Ø´ØªÙ‡:', disciplineValue || 'âŒ ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡');
            console.log('   - ÙÙ‡Ø±Ø³Øª Ø¨Ù‡Ø§:', priceListValue || 'âŒ ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡');
            
            if (!disciplineValue || !priceListValue) {
                console.warn('âš ï¸ Ù‡Ø´Ø¯Ø§Ø±: Ø¨Ø±Ø®ÛŒ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ù¾Ø± Ù†Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯');
                if (!disciplineValue) {
                    console.error('âŒ Ø±Ø´ØªÙ‡ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª');
                    alert('Ù„Ø·ÙØ§ Ø±Ø´ØªÙ‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
                    e.preventDefault();
                    return;
                }
                if (!priceListValue) {
                    console.error('âŒ ÙÙ‡Ø±Ø³Øª Ø¨Ù‡Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª');
                    alert('Ù„Ø·ÙØ§ ÙÙ‡Ø±Ø³Øª Ø¨Ù‡Ø§ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
                    e.preventDefault();
                    return;
                }
            } else {
                console.log('âœ… Ù‡Ù…Ù‡ ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¶Ø±ÙˆØ±ÛŒ Ù¾Ø± Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯');
            }
            
            setTimeout(() => {
                console.log('ğŸ“¤ Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù… Ø¨Ù‡ Ø³Ø±ÙˆØ±...');
            }, 100);
        });
    }
    
    // Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø±Ø§ÛŒ Ø­Ø§Ù„Øª edit
    console.log('âœï¸ Ø­Ø§Ù„Øª ÙˆÛŒØ±Ø§ÛŒØ´ ÙØ¹Ø§Ù„ Ø§Ø³Øª');
    console.log('   - ØµÙˆØ±Øª Ø¬Ù„Ø³Ù‡:', "{{ session.session_number }}");
    console.log('   - Ø±Ø´ØªÙ‡ Ù‚Ø¨Ù„ÛŒ:', "{{ session.discipline_choice }}");
    console.log('   - ÙÙ‡Ø±Ø³Øª Ø¨Ù‡Ø§ Ù‚Ø¨Ù„ÛŒ:', "{{ session.price_list.pk }}" || 'Ù†Ø¯Ø§Ø±Ø¯');
    
    const initialDiscipline = "{{ session.discipline_choice }}";
    if (initialDiscipline && disciplineFilter) {
        disciplineFilter.value = initialDiscipline;
        setTimeout(() => {
            updatePriceLists(initialDiscipline);
        }, 200);
    }
    
    console.log('=== Ù¾Ø§ÛŒØ§Ù† Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒØ¨Ø§Ú¯ ===');
});
</script>
{% endblock %}