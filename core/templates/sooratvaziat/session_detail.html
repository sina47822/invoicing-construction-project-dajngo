<!-- templates/sooratvaziat/session_detail.html -->

{% extends 'layout/project_base.html' %}
{% load humanize %}

{% block title %}{{ title }}{% endblock %}

{% block content %}
<div class="row">
    <!-- Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØµÙ„ÛŒ ØµÙˆØ±Øª Ø¬Ù„Ø³Ù‡ -->
    <div class="col-md-4">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">
                    <i class="fas fa-info-circle ms-2"></i>
                    Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØµÙˆØ±Øª Ø¬Ù„Ø³Ù‡
                </h5>
            </div>
            <div class="card-body">
                <table class="table table-borderless custom-table">
                    <tr>
                        <th width="40%">Ø´Ù…Ø§Ø±Ù‡ ØµÙˆØ±Øª Ø¬Ù„Ø³Ù‡:</th>
                        <td><strong>{{ session.session_number }}</strong></td>
                    </tr>
                    <tr>
                        <th>ØªØ§Ø±ÛŒØ®:</th>
                        <td>{{ session.session_date_jalali|default:"ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡" }}</td>
                    </tr>
                    <tr>
                        <th>Ø±Ø´ØªÙ‡:</th>
                        <td>
                            <span class="badge bg-secondary">
                                {% if session.price_list and session.price_list.discipline %}
                                    {{ session.price_list.discipline }}
                                {% elif session.discipline_choice %}
                                    {{ session.discipline_choice }}
                                {% else %}
                                    ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡
                                {% endif %}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>ÙˆØ¶Ø¹ÛŒØª:</th>
                        <td>
                            {% if session.status == 'approved' %}
                                <span class="badge bg-success">ØªØ§ÛŒÛŒØ¯ Ø´Ø¯Ù‡</span>
                            {% elif session.status == 'submitted' %}
                                <span class="badge bg-warning">Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡</span>
                            {% else %}
                                <span class="badge bg-secondary">Ù¾ÛŒØ´ Ù†ÙˆÛŒØ³</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <th>ØªØ¹Ø¯Ø§Ø¯ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§:</th>
                        <td><span class="badge bg-info">{{ session.items_count }}</span></td>
                    </tr>
                    <tr>
                        <th>ØªØ§Ø±ÛŒØ® Ø§ÛŒØ¬Ø§Ø¯:</th>
                        <td>{{ session.created_at|date:"Y/m/d H:i" }}</td>
                    </tr>
                </table>

                {% if session.description %}
                <div class="mt-3">
                    <strong>ØªÙˆØ¶ÛŒØ­Ø§Øª:</strong>
                    <p class="text-muted">{{ session.description }}</p>
                </div>
                {% endif %}

                <div class="d-grid gap-2 mt-3">
                    <div class="btn-group-vertical" role="group">
                        <a href="{% url 'sooratvaziat:session_edit' project.pk session.pk %}" 
                        class="btn btn-warning btn-sm text-center">
                            <i class="fas fa-edit ms-2"></i>
                            ÙˆÛŒØ±Ø§ÛŒØ´ ØµÙˆØ±Øª Ø¬Ù„Ø³Ù‡
                        </a>
                        
                        <!-- Ø¯Ú©Ù…Ù‡ Ø±ÛŒØ² Ù…ØªØ±Ù‡ -->
                        {% with discipline=session.price_list.discipline_choice|default:session.discipline_choice %}
                        {% if discipline %}
                        <a href="{% url 'sooratvaziat:riz_metre' project.pk discipline %}" 
                        class="btn btn-primary btn-sm text-center">
                            <i class="fas fa-calculator ms-2"></i>
                            Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø±ÛŒØ² Ù…ØªØ±Ù‡ 
                                {% if session.price_list and session.price_list.discipline %}
                                    {{ session.price_list.discipline }}
                                {% elif session.discipline_choice %}
                                    {{ session.discipline_choice }}
                                {% else %}
                                    ØªØ¹ÛŒÛŒÙ† Ù†Ø´Ø¯Ù‡
                                {% endif %}
                        </a>
                        {% endif %}
                        {% endwith %}
                        
                        <a href="{% url 'sooratvaziat:riz_metre_discipline_list' project.pk %}" 
                        class="btn btn-outline-info btn-sm text-center">
                            <i class="fas fa-ruler ms-2"></i>
                            ØªÙ…Ø§Ù… Ø±Ø´ØªÙ‡â€ŒÙ‡Ø§ÛŒ Ø±ÛŒØ² Ù…ØªØ±Ù‡
                        </a>
                        
                        <a href="{% url 'sooratvaziat:session_list' project.pk %}" 
                        class="btn btn-secondary btn-sm text-center">
                            <i class="fas fa-list ms-2"></i>
                            Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª ØµÙˆØ±Øª Ø¬Ù„Ø³Ø§Øª
                        </a>
                        

                    </div>
                </div>
            </div>
        </div>

        <!-- Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ -->
        <div class="card mt-3">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0">
                    <i class="fas fa-chart-bar ms-2"></i>
                    Ø¢Ù…Ø§Ø± Ú©Ù„ÛŒ
                </h6>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-6 mb-3">
                        <h4 class="text-primary">{{ session_stats.total_items }}</h4>
                        <small class="text-muted">ØªØ¹Ø¯Ø§Ø¯ Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§</small>
                    </div>
                    <div class="col-6 mb-3">
                        <h4 class="text-success">{{ session_stats.unique_pricelists }}</h4>
                        <small class="text-muted">ÙÙ‡Ø±Ø³Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù„ÛŒØ³Øª Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ ØµÙˆØ±Øª Ø¬Ù„Ø³Ù‡ -->
    <div class="col-md-8">
        <div class="card">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="fas fa-list ms-2"></i>
                    Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ ØµÙˆØ±Øª Ø¬Ù„Ø³Ù‡
                </h5>
                <button class="btn btn-light btn-sm" data-bs-toggle="modal" data-bs-target="#addItemModal">
                    <i class="fas fa-plus me-1"></i>
                    Ø§ÙØ²ÙˆØ¯Ù† Ø¢ÛŒØªÙ…
                </button>
            </div>
            <div class="card-body">
                {% if grouped_items %}
                    <div class="table-responsive">
                        <table class="table custom-table table-hover">
                            <thead class="table-primary">
                                <tr>
                                    <th width="10%">Ø´Ù…Ø§Ø±Ù‡ ÙÙ‡Ø±Ø³Øª</th>
                                    <th width="25%">Ø´Ø±Ø­ Ø¢ÛŒØªÙ…</th>
                                    <th width="10%">ÙˆØ§Ø­Ø¯</th>
                                    <th width="10%">Ù…Ù‚Ø¯Ø§Ø± Ú©Ù„</th>
                                    <th width="15%">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</th>
                                    <th width="20%">Ø¹Ù…Ù„ÛŒØ§Øª</th>
                                </tr>
                            </thead>
                            <tbody>
                            {% for group in grouped_items %}
                                <tr style="background-color: {% if group.has_revisions %}#fff3cd{% else %}#f8f9fa{% endif %};">
                                    <td class="align-middle fw-bold">{{ group.row_number }}</td>
                                    <td class="align-middle">{{ group.description }}</td>
                                    <td class="align-middle">{{ group.unit }}</td>
                                    <td class="align-middle fw-bold">{{ group.total_quantity|floatformat:2 }}</td>
                                    <td class="align-middle">
                                        {% if group.notes %}
                                            {{ group.notes }}
                                        {% else %}
                                            -
                                        {% endif %}
                                    </td>
                                    <td class="align-middle">
                                        <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ú©ÙˆÚ†Ú© Ùˆ Ø¯Ø± ÛŒÚ© Ø±Ø¯ÛŒÙ -->
                                        <div class="btn-group btn-group-sm" role="group">
                                            <!-- Ø¯Ú©Ù…Ù‡ Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª -->
                                            <button type="button" class="btn btn-info" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#itemDetailsModal"
                                                    data-group-id="{{ group.row_number }}"
                                                    title="Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª">
                                                <i class="bi bi-eye">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¬Ø²Ø¦ÛŒØ§Øª</i>
                                            </button>
                                            
                                            <!-- Ù†Ù…Ø§ÛŒØ´ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Revision -->
                                            {% if group.has_revisions %}
                                            <button type="button" class="btn btn-secondary" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#groupRevisionsModal"
                                                    data-group-id="{{ group.row_number }}"
                                                    title="ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ú¯Ø±ÙˆÙ‡">
                                                <i class="bi bi-clock-history"></i>
                                            </button>
                                            {% endif %}
                                        </div>
                                    </td>
                                </tr>
                            {% endfor %}
                            
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>Ù‡Ù†ÙˆØ² Ø¢ÛŒØªÙ…ÛŒ Ø¨Ù‡ Ø§ÛŒÙ† ØµÙˆØ±Øª Ø¬Ù„Ø³Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª.</p>
                        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addItemModal">
                            <i class="fas fa-plus me-1"></i>
                            Ø§ÙØ²ÙˆØ¯Ù† Ø¢ÛŒØªÙ…
                        </button>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Modal Ø§ÙØ²ÙˆØ¯Ù† Ø¢ÛŒØªÙ… Ø¬Ø¯ÛŒØ¯ -->
<div class="modal fade" id="addItemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ø§ÙØ²ÙˆØ¯Ù† Ø¢ÛŒØªÙ… Ø¬Ø¯ÛŒØ¯</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form method="post" action="{% url 'sooratvaziat:add_session_item' project.pk session.pk %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Ø¢ÛŒØªÙ… ÙÙ‡Ø±Ø³Øª Ø¨Ù‡Ø§ *</label>
                                <select name="pricelist_item" class="form-select" required id="pricelist-select">
                                    <option value="">-- Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ --</option>
                                    {% for item in pricelist_items %}
                                        <option value="{{ item.pk }}" 
                                                data-unit="{{ item.unit }}"
                                                data-description="{{ item.description }}"
                                                data-price="{{ item.price }}">
                                            {{ item.row_number }} - {{ item.description }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">Ø´Ø±Ø­ Ø±Ø¯ÛŒÙ *</label>
                                <input type="text" name="row_description" class="form-control" 
                                       placeholder="Ù…Ø«Ø§Ù„: Ø¯ÛŒÙˆØ§Ø± Ø´Ù…Ø§Ù„ÛŒ - Ø·Ø¨Ù‚Ù‡ Ø§ÙˆÙ„" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Ø·ÙˆÙ„ (Ù…ØªØ±)</label>
                                <input type="number" step="0.01" name="length" class="form-control" 
                                       placeholder="0.00" value="0">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Ø¹Ø±Ø¶ (Ù…ØªØ±)</label>
                                <input type="number" step="0.01" name="width" class="form-control" 
                                       placeholder="0.00" value="0">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">Ø§Ø±ØªÙØ§Ø¹ (Ù…ØªØ±)</label>
                                <input type="number" step="0.01" name="height" class="form-control" 
                                       placeholder="0.00" value="0">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">ØªØ¹Ø¯Ø§Ø¯ *</label>
                                <input type="number" step="0.01" name="count" class="form-control" 
                                       value="1" required min="0.01">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">ÙˆØ²Ù† (Ú©ÛŒÙ„ÙˆÚ¯Ø±Ù…)</label>
                                <input type="number" step="0.01" name="weight" class="form-control" 
                                       placeholder="0.00" value="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label class="form-label">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</label>
                                <textarea name="notes" class="form-control" rows="2" 
                                          placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø§ÛŒÙ† Ø±Ø¯ÛŒÙ"></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
                    <button type="submit" class="btn btn-primary">Ø°Ø®ÛŒØ±Ù‡ Ø¢ÛŒØªÙ…</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal ÙˆÛŒØ±Ø§ÛŒØ´ Ø¢ÛŒØªÙ… -->
<div class="modal fade" id="editItemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <!-- Ù‡Ø¯Ø± Ø¨Ø§ Ø±Ù†Ú¯ Ø¢Ø¨ÛŒ ÙˆØ§Ù‚Ø¹ÛŒ -->
            <div class="modal-header text-white" style="background-color: #0d6efd;">
                <h5 class="modal-title">ÙˆÛŒØ±Ø§ÛŒØ´ Ø¢ÛŒØªÙ…</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            
            <form method="post" action="{% url 'sooratvaziat:edit_session_item' project_pk=project.pk session_pk=session.pk item_pk=0 %}" id="editItemForm">
                {% csrf_token %}
                <div class="modal-body bg-light">
                    <input type="hidden" name="item_id" id="editItemId">
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editLength" class="form-label fw-bold text-dark">Ø·ÙˆÙ„ (Ù…ØªØ±)</label>
                                <input type="number" step="0.01" class="form-control" id="editLength" name="length" placeholder="0.00" style="border-color: #0d6efd;">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editWidth" class="form-label fw-bold text-dark">Ø¹Ø±Ø¶ (Ù…ØªØ±)</label>
                                <input type="number" step="0.01" class="form-control" id="editWidth" name="width" placeholder="0.00" style="border-color: #0d6efd;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editHeight" class="form-label fw-bold text-dark">Ø§Ø±ØªÙØ§Ø¹ (Ù…ØªØ±)</label>
                                <input type="number" step="0.01" class="form-control" id="editHeight" name="height" placeholder="0.00" style="border-color: #0d6efd;">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="editCount" class="form-label fw-bold text-dark">ØªØ¹Ø¯Ø§Ø¯</label>
                                <input type="number" step="0.01" class="form-control" id="editCount" name="count" value="1" style="border-color: #0d6efd;">
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="editNotes" class="form-label fw-bold text-dark">ÛŒØ§Ø¯Ø¯Ø§Ø´Øª</label>
                        <textarea class="form-control" id="editNotes" name="notes" rows="2" placeholder="ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…Ø±Ø¨ÙˆØ· Ø¨Ù‡ Ø§ÛŒÙ† Ø¢ÛŒØªÙ…..." style="border-color: #0d6efd;"></textarea>
                    </div>
                    
                    {% if not user_can_edit_directly %}
                    <div class="mb-3 p-3 rounded" style="background-color: #fff3cd; border: 1px solid #ffc107;">
                        <label for="revisionReason" class="form-label fw-bold text-dark">Ø¯Ù„ÛŒÙ„ Ø§ØµÙ„Ø§Ø­</label>
                        <input type="text" class="form-control" id="revisionReason" name="revision_reason" 
                               placeholder="Ø¹Ù„Øª ØªØºÛŒÛŒØ± Ø§ÛŒÙ† Ø¢ÛŒØªÙ… Ø±Ø§ ØªÙˆØ¶ÛŒØ­ Ø¯Ù‡ÛŒØ¯" required style="border-color: #ffc107;">
                        <div class="form-text mt-2" style="color: #856404;">
                            <i class="bi bi-exclamation-triangle"></i>
                            Ø§ÛŒÙ† ØªØºÛŒÛŒØ± Ø¨Ù‡ ØµÙˆØ±Øª Ø§ØµÙ„Ø§Ø­ÛŒÙ‡ Ø«Ø¨Øª Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ù¾Ø³ Ø§Ø² ØªØ£ÛŒÛŒØ¯ Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø± Ø§Ø¹Ù…Ø§Ù„ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.
                        </div>
                    </div>
                    {% endif %}
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
                    <button type="submit" class="btn text-white" style="background-color: #0d6efd;">Ø°Ø®ÛŒØ±Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal Ø¨Ø±Ø§ÛŒ Ù†Ù…Ø§ÛŒØ´ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØºÛŒÛŒØ±Ø§Øª -->
<div class="modal fade" id="revisionsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ø¢ÛŒØªÙ…</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="revisionsContent">
                <!-- Ù…Ø­ØªÙˆØ§ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ø§ AJAX Ù¾Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯ -->
            </div>
        </div>
    </div>
</div>


<!-- Modal Ø­Ø°Ù Ø¢ÛŒØªÙ… -->
<div class="modal fade" id="deleteItemModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ØªØ§ÛŒÛŒØ¯ Ø­Ø°Ù Ø¢ÛŒØªÙ…</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø¢ÛŒØªÙ… "<span id="delete-item-description"></span>" Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ</p>
                <p class="text-warning"><small>Ø§ÛŒÙ† Ø¹Ù…Ù„ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
                <form method="post" action="" id="delete-item-form">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Ø­Ø°Ù Ø¢ÛŒØªÙ…</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Modal ØªØ§ÛŒÛŒØ¯ Ø­Ø°Ù Ú¯Ø±ÙˆÙ‡ -->
<div class="modal fade" id="deleteGroupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">ØªØ§ÛŒÛŒØ¯ Ø­Ø°Ù Ú¯Ø±ÙˆÙ‡</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù ØªÙ…Ø§Ù… Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ú¯Ø±ÙˆÙ‡ "<span id="delete-group-description"></span>" Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ</p>
                <p class="text-danger"><small>Ø§ÛŒÙ† Ø¹Ù…Ù„ ØªÙ…Ø§Ù… Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ø§ÛŒÙ† Ú¯Ø±ÙˆÙ‡ Ø±Ø§ Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ù‚Ø§Ø¨Ù„ Ø¨Ø§Ø²Ú¯Ø´Øª Ù†ÛŒØ³Øª.</small></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
                <form method="post" action="" id="delete-group-form">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-danger">Ø­Ø°Ù Ú¯Ø±ÙˆÙ‡</button>
                </form>
            </div>
        </div>
    </div>
</div>
<!-- Modal Ø¬Ø²Ø¦ÛŒØ§Øª Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ú¯Ø±ÙˆÙ‡ -->
<div class="modal fade" id="itemDetailsModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Ø¬Ø²Ø¦ÛŒØ§Øª Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§ÛŒ Ú¯Ø±ÙˆÙ‡ <span id="modalGroupNumber"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="itemDetailsContent">
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
                    </div>
                    <p>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¬Ø²Ø¦ÛŒØ§Øª...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø¨Ø³ØªÙ†</button>
            </div>
        </div>
    </div>
</div>

<!-- Ø¯Ø± Ø§Ù†ØªÙ‡Ø§ÛŒ block content -->
<div class="mt-3">
    <details>
        <summary>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¯ÛŒØ¨Ø§Ú¯ (ÙÙ‚Ø· Ø¨Ø±Ø§ÛŒ ØªÙˆØ³Ø¹Ù‡)</summary>
        <div class="alert alert-info">
            <strong>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¬Ù„Ø³Ù‡:</strong><br>
            - Ù¾Ø±ÙˆÚ˜Ù‡: {{ project.pk }}<br>
            - Ø¬Ù„Ø³Ù‡: {{ session.pk }}<br>
            - Ú©Ø§Ø±Ø¨Ø±: {{ request.user.username }}<br>
            - Ù†Ù‚Ø´: {{ user_role }}<br>
            - Ø§Ù…Ú©Ø§Ù† ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ø³ØªÙ‚ÛŒÙ…: {{ user_can_edit_directly }}<br>
        </div>
    </details>
</div>
{% endblock %}
{% block extra_css %}
<style>


</style>
{% endblock %}
{% block extra_js %}
<script>
// Ù…Ø¯ÛŒØ±ÛŒØª Ø±ÙˆÛŒØ¯Ø§Ø¯Ù‡Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ùˆ Ø­Ø°Ù Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§
document.addEventListener('DOMContentLoaded', function() {
    // ÙˆÛŒØ±Ø§ÛŒØ´ Ø¢ÛŒØªÙ…
    const editButtons = document.querySelectorAll('.edit-item-btn');
    
    editButtons.forEach(button => {
        button.addEventListener('click', function() {
            const itemId = this.dataset.itemId;
            const pricelistItemId = this.dataset.pricelistItemId;
            const rowDescription = this.dataset.rowDescription;
            const length = this.dataset.length;
            const width = this.dataset.width;
            const height = this.dataset.height;
            const count = this.dataset.count;
            const weight = this.dataset.weight;
            const notes = this.dataset.notes;
            
            console.log('Editing item data:', {
                itemId, pricelistItemId, rowDescription, 
                length, width, height, count, weight, notes
            });
            
            // ØªÙ†Ø¸ÛŒÙ… action ÙØ±Ù…
            document.getElementById('edit-item-form').action = 
                "{% url 'sooratvaziat:edit_session_item' project.pk session.pk 0 %}".replace('0', itemId);
            
            // Ù¾Ø± Ú©Ø±Ø¯Ù† ÙØ±Ù… Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯
            document.getElementById('edit-pricelist-item').value = pricelistItemId || '';
            document.getElementById('edit-row-description').value = rowDescription || '';
            document.getElementById('edit-length').value = length || '';
            document.getElementById('edit-width').value = width || '';
            document.getElementById('edit-height').value = height || '';
            document.getElementById('edit-count').value = count || '1';
            document.getElementById('edit-weight').value = weight || '';
            document.getElementById('edit-notes').value = notes || '';
            
            // Ø¯ÛŒØ¨Ø§Ú¯: Ù†Ù…Ø§ÛŒØ´ Ù…Ù‚Ø§Ø¯ÛŒØ± Ù¾Ø± Ø´Ø¯Ù‡
            console.log('Form values after filling:', {
                pricelist_item: document.getElementById('edit-pricelist-item').value,
                row_description: document.getElementById('edit-row-description').value,
                length: document.getElementById('edit-length').value,
                width: document.getElementById('edit-width').value,
                height: document.getElementById('edit-height').value,
                count: document.getElementById('edit-count').value,
                weight: document.getElementById('edit-weight').value,
                notes: document.getElementById('edit-notes').value
            });
        });
    });
    
    const editModal = document.getElementById('editItemModal');
    const editForm = document.getElementById('editItemForm');
    
    editModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const itemId = button.getAttribute('data-item-id');
        const itemLength = button.getAttribute('data-item-length');
        const itemWidth = button.getAttribute('data-item-width');
        const itemHeight = button.getAttribute('data-item-height');
        const itemCount = button.getAttribute('data-item-count');
        const itemNotes = button.getAttribute('data-item-notes');
        
        // Ù¾Ø± Ú©Ø±Ø¯Ù† ÙØ±Ù…
        document.getElementById('editItemId').value = itemId;
        document.getElementById('editLength').value = itemLength;
        document.getElementById('editWidth').value = itemWidth;
        document.getElementById('editHeight').value = itemHeight;
        document.getElementById('editCount').value = itemCount;
        document.getElementById('editNotes').value = itemNotes;
        
        // Ø¢Ù¾Ø¯ÛŒØª action ÙØ±Ù…
        editForm.action = editForm.action.replace('/0/', `/${itemId}/`);
    });
    
    // Ù…Ø¯ÛŒØ±ÛŒØª Modal ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
    const revisionsModal = document.getElementById('revisionsModal');
    revisionsModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const itemId = button.getAttribute('data-item-id');
        
        // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØºÛŒÛŒØ±Ø§Øª Ø¨Ø§ AJAX
        fetch(`/sooratvaziat/projects/${project_pk}/sessions/${session_pk}/items/${itemId}/revisions/`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.text();
            })
            .then(html => {
                document.getElementById('revisionsContent').innerHTML = html;
            })
            .catch(error => {
                console.error('Error loading revisions:', error);
                document.getElementById('revisionsContent').innerHTML = 
                    '<div class="alert alert-danger">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ ØªØºÛŒÛŒØ±Ø§Øª</div>';
            });
    });
    // Ø­Ø°Ù Ø¢ÛŒØªÙ…
    const deleteButtons = document.querySelectorAll('.delete-item-btn');
    deleteButtons.forEach(button => {
        button.addEventListener('click', function() {
            const itemId = this.dataset.itemId;
            const itemDescription = this.dataset.itemDescription;
            
            console.log('Deleting item:', itemId, itemDescription);
            
            // ØªÙ†Ø¸ÛŒÙ… action ÙØ±Ù…
            document.getElementById('delete-item-form').action = 
                "{% url 'sooratvaziat:delete_session_item' project.pk session.pk 0 %}".replace('0', itemId);
            
            // Ù†Ù…Ø§ÛŒØ´ Ø´Ø±Ø­ Ø¢ÛŒØªÙ…
            document.getElementById('delete-item-description').textContent = itemDescription;
        });
    });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const editButtons = document.querySelectorAll('.edit-item-btn');
    editButtons.forEach(button => {
        button.addEventListener('click', function() {
            console.log('Button clicked - Data attributes:');
            console.log('item-id:', this.dataset.itemId);
            console.log('pricelist-item-id:', this.dataset.pricelistItemId);
            console.log('pricelist-text:', this.dataset.pricelistText);
            console.log('row-description:', this.dataset.rowDescription);
            console.log('length:', this.dataset.length);
            console.log('width:', this.dataset.width);
            console.log('height:', this.dataset.height);
            console.log('count:', this.dataset.count);
            console.log('weight:', this.dataset.weight);
            console.log('notes:', this.dataset.notes);
        });
    });
});
</script>

<script>
// Ù…Ø¯ÛŒØ±ÛŒØª Modal ÙˆÛŒØ±Ø§ÛŒØ´ Ø¢ÛŒØªÙ…
const editItemModal = document.getElementById('editItemModal');
const editItemForm = document.getElementById('editItemForm');

editItemModal.addEventListener('show.bs.modal', function(event) {
    const button = event.relatedTarget;
    const itemId = button.getAttribute('data-item-id');
    const itemLength = button.getAttribute('data-item-length');
    const itemWidth = button.getAttribute('data-item-width');
    const itemHeight = button.getAttribute('data-item-height');
    const itemCount = button.getAttribute('data-item-count');
    const itemNotes = button.getAttribute('data-item-notes');
    
    console.log('ğŸ“ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¢ÛŒØªÙ…:', {
        itemId, itemLength, itemWidth, itemHeight, itemCount, itemNotes
    });
    
    // Ù¾Ø± Ú©Ø±Ø¯Ù† ÙØ±Ù… Ø¨Ø§ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø¢ÛŒØªÙ…
    document.getElementById('editItemId').value = itemId;
    document.getElementById('editLength').value = itemLength;
    document.getElementById('editWidth').value = itemWidth;
    document.getElementById('editHeight').value = itemHeight;
    document.getElementById('editCount').value = itemCount;
    document.getElementById('editNotes').value = itemNotes;
    
    // Ø¨Ù‡ Ø±ÙˆØ² Ø±Ø³Ø§Ù†ÛŒ action ÙØ±Ù… Ø¨Ø§ Ø¢ÛŒ Ø¯ÛŒ Ø¢ÛŒØªÙ…
    const newAction = editItemForm.action.replace('/0/', `/${itemId}/`);
    editItemForm.action = newAction;
    
    console.log('âœ… ÙØ±Ù… ÙˆÛŒØ±Ø§ÛŒØ´ Ù¾Ø± Ø´Ø¯. Action:', newAction);
});

// Ù…Ø¯ÛŒØ±ÛŒØª Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù… ÙˆÛŒØ±Ø§ÛŒØ´
editItemForm.addEventListener('submit', function(e) {
    console.log('ğŸš€ Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù… ÙˆÛŒØ±Ø§ÛŒØ´ Ø¢ÛŒØªÙ…...');
    
    const formData = new FormData(editItemForm);
    console.log('ğŸ“„ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ÙØ±Ù… ÙˆÛŒØ±Ø§ÛŒØ´:');
    for (let [key, value] of formData.entries()) {
        console.log(`   - ${key}: ${value}`);
    }
});

// Ù…Ø¯ÛŒØ±ÛŒØª Modal Ø¬Ø²Ø¦ÛŒØ§Øª Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§
document.addEventListener('DOMContentLoaded', function() {
    const itemDetailsModal = document.getElementById('itemDetailsModal');
    
    itemDetailsModal.addEventListener('show.bs.modal', function(event) {
        const button = event.relatedTarget;
        const groupNumber = button.getAttribute('data-group-id');
        
        console.log('ğŸ“– Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø²Ø¦ÛŒØ§Øª Ú¯Ø±ÙˆÙ‡:', groupNumber);
        
        document.getElementById('modalGroupNumber').textContent = groupNumber;
        
        const url = `{% url 'sooratvaziat:group_items_detail' project.pk session.pk '0' %}`.replace('0', groupNumber);
        console.log('ğŸ”— URL Ø¯Ø±Ø®ÙˆØ§Ø³Øª:', url);
        
        fetch(url)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡: ${response.status}`);
                }
                return response.text();
            })
            .then(html => {
                document.getElementById('itemDetailsContent').innerHTML = html;
                console.log('âœ… Ø¬Ø²Ø¦ÛŒØ§Øª Ú¯Ø±ÙˆÙ‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯');
                
                // Ø¨Ø¹Ø¯ Ø§Ø² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¬Ø²Ø¦ÛŒØ§ØªØŒ event listenerÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ú©Ù†
                attachEditEventListeners();
            })
            .catch(error => {
                console.error('âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¬Ø²Ø¦ÛŒØ§Øª Ú¯Ø±ÙˆÙ‡:', error);
                document.getElementById('itemDetailsContent').innerHTML = 
                    `<div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle"></i>
                        Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¬Ø²Ø¦ÛŒØ§Øª Ú¯Ø±ÙˆÙ‡: ${error.message}
                    </div>`;
            });
    });
    
    function attachEditEventListeners() {
        // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø± Ù…Ø­ØªÙˆØ§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯Ù‡
        const editButtons = document.querySelectorAll('#itemDetailsContent .edit-item-btn');
        editButtons.forEach(button => {
            button.addEventListener('click', function() {
                console.log('ğŸ¯ Ø¯Ú©Ù…Ù‡ ÙˆÛŒØ±Ø§ÛŒØ´ Ø¯Ø± Ø¬Ø²Ø¦ÛŒØ§Øª Ú¯Ø±ÙˆÙ‡ Ú©Ù„ÛŒÚ© Ø´Ø¯');
            });
        });
    }
    
    // Ù…Ø¯ÛŒØ±ÛŒØª Ø­Ø°Ù ØªÚ©â€ŒØªÚ© Ø¢ÛŒØªÙ…â€ŒÙ‡Ø§
    document.addEventListener('click', function(e) {
        if (e.target.closest('.delete-single-item-btn')) {
            const button = e.target.closest('.delete-single-item-btn');
            const itemId = button.getAttribute('data-item-id');
            const itemDescription = button.getAttribute('data-item-description');
            
            if (confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø¢ÛŒØªÙ… "${itemDescription}" Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ`)) {
                const url = `{% url 'sooratvaziat:delete_session_item' project.pk session.pk 0 %}`.replace('0', itemId);
                
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                })
                .then(response => {
                    if (response.ok) {
                        location.reload();
                    } else {
                        alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¢ÛŒØªÙ…');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù Ø¢ÛŒØªÙ…');
                });
            }
        }
    });
});
</script>
{% endblock %}