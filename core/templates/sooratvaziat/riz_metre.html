<!-- templates/sooratvaziat/riz_metre.html -->

{% extends 'layout/base.html' %}

{% load static %}

{% block title %}ریز متره - {{ project.project_name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/riz_metre.css' %}">
<style>
    /* Page-specific styles */
    .riz-metre-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 1rem;
        padding: 2rem;
        margin-bottom: 2rem;
        position: relative;
        overflow: hidden;
    }
    
    .riz-metre-header::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="25" cy="25" r="1" fill="white" opacity="0.1"/><circle cx="75" cy="75" r="1" fill="white" opacity="0.1"/><circle cx="50" cy="10" r="0.5" fill="white" opacity="0.05"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
        opacity: 0.2;
    }
    
    .measurement-table {
        background: white;
        border-radius: 1rem;
        overflow: hidden;
        box-shadow: 0 0.25rem 0.5rem rgba(0, 0, 0, 0.1);
        margin-bottom: 2rem;
    }
    
    .group-header {
        background: linear-gradient(135deg, #495057, #6c757d);
        color: white;
        font-weight: 600;
        padding: 1rem;
    }
    
    .item-row {
        transition: background-color 0.2s ease;
        border-left: 4px solid transparent;
    }
    
    .item-row:hover {
        background-color: #ffffff;
        border-left-color: var(--primary-color);
    }
    
    .group-total {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        font-weight: 700;
        font-size: 1.1rem;
    }
    
    .stats-grid .card-custom {
        transition: all 0.3s ease;
        border: none;
        border-radius: 1rem;
        overflow: hidden;
    }
    
    .stats-grid .card-custom:hover {
        transform: translateY(-5px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
    }
    
    .action-buttons .btn {
        border-radius: 0.75rem;
        padding: 0.75rem 1.25rem;
        font-weight: 600;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }
    
    .action-buttons .btn::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
        transition: left 0.5s;
    }
    
    .action-buttons .btn:hover::before {
        left: 100%;
    }
    
    .action-buttons .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    }
    
    @media (max-width: 768px) {
        .riz-metre-header {
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        
        .action-buttons .row {
            flex-direction: column;
        }
        
        .action-buttons .btn {
            margin-bottom: 0.5rem;
        }
        
        .stats-grid {
            flex-direction: column;
        }
        
        .stats-grid .col-md-4 {
            margin-bottom: 1rem;
        }
    }
    
    .print-friendly {
        @media print {
            .no-print { display: none !important; }
            .action-buttons { display: none !important; }
            .measurement-table { box-shadow: none !important; border: 1px solid #000 !important; }
            .group-header, .group-total { background: #f0f0f0 !important; color: #000 !important; }
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4 print-friendly">

    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb bg-transparent p-0">
            <li class="breadcrumb-item">
                <a href="{% url 'accounts:dashboard' %}" class="text-decoration-none">
                    <i class="bi bi-house-door me-1"></i> داشبورد
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'sooratvaziat:project_financial_report_list' %}" class="text-decoration-none">
                    <i class="bi bi-list-ul me-1"></i> لیست پروژه‌ها
                </a>
            </li>
            <li class="breadcrumb-item">
                <a href="{% url 'project_financial_report' project.id %}" class="text-decoration-none">
                    <i class="bi bi-file-bar-graph me-1"></i> {{ project.project_name }}
                </a>
            </li>
            <li class="breadcrumb-item active" aria-current="page">
                <i class="bi bi-ruler me-1"></i> ریز متره
                {% if discipline_label %}
                    <span class="badge bg-primary ms-1">{{ discipline_label }}</span>
                {% endif %}
            </li>
        </ol>
    </nav>

    <!-- Header Section -->
    <div class="riz-metre-header text-center position-relative">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="display-5 fw-bold mb-2">
                    <i class="bi bi-ruler-combined me-2"></i>
                    گزارش ریز متره
                </h1>
                {% if project %}
                <h2 class="h4 mb-2">{{ project.project_name }}</h2>
                <div class="d-flex justify-content-center flex-wrap gap-2 mb-0">
                    <span class="badge bg-light text-dark px-2 py-1">
                        <i class="bi bi-hash me-1"></i> {{ project.project_code }}
                    </span>
                    <span class="badge bg-light text-dark px-2 py-1">
                        <i class="bi bi-calendar3 me-1"></i> {{ project.execution_year }}
                    </span>
                    {% if discipline_label %}
                    <span class="badge bg-primary px-2 py-1">
                        <i class="bi bi-gear me-1"></i> {{ discipline_label }}
                    </span>
                    {% endif %}
                </div>
                {% endif %}
            </div>
            <div class="col-md-4 text-md-end">
                <div class="project-meta small text-white-50">
                    <div class="mb-1">
                        <i class="bi bi-person-check me-1"></i>
                        <strong>مسئول:</strong> {{ project.manager.get_full_name|default:project.manager.username }}
                    </div>
                    {% if project.start_date %}
                    <div class="mb-1">
                        <i class="bi bi-calendar-event me-1"></i>
                        <strong>شروع:</strong> {{ project.start_date|date:"Y/m/d" }}
                    </div>
                    {% endif %}
                    {% if project.end_date %}
                    <div>
                        <i class="bi bi-calendar-check me-1"></i>
                        <strong>پایان:</strong> {{ project.end_date|date:"Y/m/d" }}
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons no-print mb-4">
        <div class="row g-2 g-md-3">
            <div class="col-md-3 col-sm-6">
                <a href="{% url 'riz_financial_discipline_list' project.id %}" 
                   class="btn btn-success w-100 btn-custom h-100 text-white"
                   data-bs-toggle="tooltip" title="مشاهده اطلاعات مالی پروژه">
                    <i class="bi bi-calculator me-2"></i>
                    <span class="d-none d-md-inline">ریز مالی</span>
                    <span class="d-md-none">مالی</span>
                </a>
            </div>
            <div class="col-md-3 col-sm-6">
                <a href="{% url 'sooratvaziat:session_list' project.id %}" 
                   class="btn btn-warning w-100 btn-custom h-100 text-white"
                   data-bs-toggle="tooltip" title="مشاهده صورت جلسات پروژه">
                    <i class="bi bi-calendar-event me-2"></i>
                    <span class="d-none d-md-inline">صورت جلسات</span>
                    <span class="d-md-none">جلسات</span>
                </a>
            </div>
            <div class="col-md-3 col-sm-6">
                <a href="{% url 'project_financial_report' project.id %}" 
                   class="btn btn-primary w-100 btn-custom h-100 text-white"
                   data-bs-toggle="tooltip" title="گزارش جامع مالی پروژه">
                    <i class="bi bi-file-bar-graph me-2"></i>
                    <span class="d-none d-md-inline">گزارش مالی</span>
                    <span class="d-md-none">گزارش</span>
                </a>
            </div>
            <div class="col-md-3 col-sm-6">
                <a href="{% url 'sooratvaziat:project_financial_report_list' %}" 
                   class="btn btn-outline-secondary w-100 btn-custom h-100"
                   data-bs-toggle="tooltip" title="بازگشت به لیست پروژه‌ها">
                    <i class="bi bi-list-ul me-2"></i>
                    <span class="d-none d-md-inline">لیست پروژه‌ها</span>
                    <span class="d-md-none">پروژه‌ها</span>
                </a>
            </div>
        </div>
        
        <!-- Additional Actions -->
        <div class="row g-2 mt-2">
            <div class="col-md-3 col-sm-6">
                <button class="btn btn-outline-primary w-100 btn-custom" 
                        onclick="window.print()" 
                        data-bs-toggle="tooltip" title="چاپ گزارش">
                    <i class="bi bi-printer me-2"></i>
                    <span class="d-none d-md-inline">چاپ</span>
                    <span class="d-md-none">پرینت</span>
                </button>
            </div>
            <div class="col-md-3 col-sm-6">
                <button class="btn btn-outline-success w-100 btn-custom" 
                        id="export-pdf" 
                        data-bs-toggle="tooltip" title="صدور به PDF">
                    <i class="bi bi-file-earmark-pdf me-2"></i>
                    <span class="d-none d-md-inline">صدور PDF</span>
                    <span class="d-md-none">PDF</span>
                </button>
            </div>
            <div class="col-md-3 col-sm-6">
                <button class="btn btn-outline-info w-100 btn-custom" 
                        id="export-excel" 
                        data-bs-toggle="tooltip" title="صدور به Excel">
                    <i class="bi bi-file-earmark-excel me-2"></i>
                    <span class="d-none d-md-inline">صدور Excel</span>
                    <span class="d-md-none">Excel</span>
                </button>
            </div>
            <div class="col-md-3 col-sm-6">
                <a href="{% url 'riz_metre_discipline_list' project.id %}" 
                   class="btn btn-outline-warning w-100 btn-custom"
                   data-bs-toggle="tooltip" title="تغییر رشته">
                    <i class="bi bi-arrow-repeat me-2"></i>
                    <span class="d-none d-md-inline">تغییر رشته</span>
                    <span class="d-md-none">رشته</span>
                </a>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4 stats-grid">
        <div class="col-md-4 col-sm-6">
            <div class="card card-custom bg-warning text-white h-100">
                <div class="card-body text-center">
                    <div class="stat-icon mb-3" style="background: rgba(255, 193, 7, 0.2); color: #856404;">
                        <i class="bi bi-layer-group fs-1"></i>
                    </div>
                    <h3 class="stat-number mb-1">{{ groups|length|default:0 }}</h3>
                    <h5 class="stat-label mb-0">گروه‌های متره</h5>
                    <small class="text-white-50">
                        {% if groups %}
                            {{ groups|length }} ردیف از فهرست‌بها
                        {% else %}
                            بدون آیتم
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>

        <div class="col-md-4 col-sm-6">
            <div class="card card-custom bg-info text-white h-100">
                <div class="card-body text-center">
                    <div class="stat-icon mb-3" style="background: rgba(13, 202, 240, 0.2); color: #0c5460;">
                        <i class="bi bi-cubes fs-1"></i>
                    </div>
                    {% comment %} محاسبه تعداد کل آیتم‌ها {% endcomment %}
                    {% with total_items=0 %}
                        {% for group in groups %}
                            {% with group_items=group.items|length %}
                                {% with total_items=total_items|add:group_items %}
                                {% endwith %}
                            {% endwith %}
                        {% empty %}
                            {% with total_items=0 %}
                            {% endwith %}
                        {% endfor %}
                        <h3 class="stat-number mb-1">{{ total_items }}</h3>
                        <h5 class="stat-label mb-0">آیتم‌های متره</h5>
                        <small class="text-white-50">
                            {% if total_items %}
                                {{ total_items }} آیتم ثبت شده
                            {% else %}
                                بدون آیتم
                            {% endif %}
                        </small>
                    {% endwith %}
                </div>
            </div>
        </div>

        <div class="col-md-4 col-sm-6">
            <div class="card card-custom bg-success text-white h-100">
                <div class="card-body text-center">
                    <div class="stat-icon mb-3" style="background: rgba(25, 135, 84, 0.2); color: #155724;">
                        <i class="bi bi-ruler fs-1"></i>
                    </div>
                    {% comment %} محاسبه جمع کل {% endcomment %}
                    {% with grand_total=0 %}
                        {% for group in groups %}
                            {% with group_total=group.group_total %}
                                {% with grand_total=grand_total|add:group_total %}
                                {% endwith %}
                            {% endwith %}
                        {% empty %}
                            {% with grand_total=0 %}
                            {% endwith %}
                        {% endfor %}
                        <h3 class="stat-number mb-1">{{ grand_total|floatformat:2|default:0 }}</h3>
                        <h5 class="stat-label mb-0">جمع کل متره</h5>
                        <small class="text-white-50">
                            {% if grand_total %}
                                {{ grand_total|floatformat:2 }} واحد متره
                            {% else %}
                                بدون مقدار
                            {% endif %}
                        </small>
                    {% endwith %}
                </div>
            </div>
        </div>
    </div>

    {% if groups %}
    <!-- Measurement Table -->
    <div class="measurement-table">
        <div class="card-header-custom d-flex justify-content-between align-items-center">
            <h5 class="card-title-custom mb-0">
                <i class="bi bi-table me-2"></i>
                جدول جامع آیتم‌های متره
            </h5>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-primary btn-sm" id="toggle-columns">
                    <i class="bi bi-columns-gap me-1"></i>ستون‌ها
                </button>
                <button class="btn btn-outline-secondary btn-sm" id="copy-table">
                    <i class="bi bi-copy me-1"></i>کپی
                </button>
                <button class="btn btn-outline-success btn-sm" id="search-table">
                    <i class="bi bi-search me-1"></i>جستجو
                </button>
            </div>
        </div>
        
        <div class="table-responsive">
            <table class="table table-hover mb-0" id="measurement-table">
                <thead class="table-dark">
                    <tr>
                        <th scope="col" class="position-sticky" style="top: 0; z-index: 10;">
                            <i class="bi bi-hash"></i> ردیف
                        </th>
                        <th scope="col" class="position-sticky" style="top: 0; z-index: 10;">
                            <i class="bi bi-tag"></i> شماره آیتم
                        </th>
                        <th scope="col" class="position-sticky" style="top: 0; z-index: 10; min-width: 200px;">
                            <i class="bi bi-file-text"></i> شرح آیتم
                        </th>
                        <th scope="col" class="position-sticky" style="top: 0; z-index: 10; text-align: center;">
                            <i class="bi bi-arrow-left-right"></i> طول
                        </th>
                        <th scope="col" class="position-sticky" style="top: 0; z-index: 10; text-align: center;">
                            <i class="bi bi-arrow-left-right"></i> عرض
                        </th>
                        <th scope="col" class="position-sticky" style="top: 0; z-index: 10; text-align: center;">
                            <i class="bi bi-arrow-up-down"></i> ارتفاع
                        </th>
                        <th scope="col" class="position-sticky" style="top: 0; z-index: 10; text-align: center;">
                            <i class="bi bi-weigh"></i> وزن
                        </th>
                        <th scope="col" class="position-sticky" style="top: 0; z-index: 10; text-align: center;">
                            <i class="bi bi-collection"></i> تعداد
                        </th>
                        <th scope="col" class="position-sticky" style="top: 0; z-index: 10; text-align: center; font-weight: 700;">
                            <i class="bi bi-calculator"></i> مقدار
                        </th>
                        <th scope="col" class="position-sticky" style="top: 0; z-index: 10; min-width: 120px;">
                            <i class="bi bi-calendar-event"></i> صورت جلسه
                        </th>
                        <th scope="col" class="position-sticky" style="top: 0; z-index: 10; min-width: 100px;">
                            <i class="bi bi-calendar"></i> تاریخ
                        </th>
                    </tr>
                </thead>
                <tbody>
                    {% for g in groups %}
                        <tr class="group-header">
                            <td colspan="11" class="py-3">
                                <div class="d-flex align-items-center">
                                    <div class="group-icon me-3" style="background: linear-gradient(135deg, #6c757d, #495057); color: white; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; flex-shrink: 0;">
                                        <i class="bi bi-folder2 fs-5"></i>
                                    </div>
                                    <div class="flex-grow-1">
                                        <h6 class="mb-1 fw-bold">
                                            ردیف {{ g.row_number }} 
                                            <span class="badge bg-light text-dark ms-2">{{ g.unit }}</span>
                                        </h6>
                                        <small class="text-white-50">
                                            {{ g.row_description|default:g.pricelist_item.description }}
                                            {% if g.pricelist_item.item_code %}
                                                <span class="ms-2">| کد: {{ g.pricelist_item.item_code }}</span>
                                            {% endif %}
                                        </small>
                                    </div>
                                    <div class="text-end">
                                        <span class="badge bg-success fs-6">
                                            {{ g.items|length }} آیتم
                                        </span>
                                    </div>
                                </div>
                            </td>
                        </tr>

                        {% for item in g.items %}
                            <tr class="item-row" data-item-id="{{ item.id }}" data-group="{{ g.row_number }}">
                                <td class="align-middle">
                                    <span class="badge bg-secondary fs-6">{{ forloop.parentloop.counter }}.{{ forloop.counter }}</span>
                                </td>
                                <td class="align-middle fw-semibold">{{ g.row_number }}</td>
                                <td class="align-middle text-start">
                                    <div class="item-description">
                                        <div class="fw-medium">{{ item.instance.row_description|default:g.pricelist_item.description }}</div>
                                        {% if item.instance.specifications %}
                                            <small class="text-muted d-block">{{ item.instance.specifications }}</small>
                                        {% endif %}
                                        {% if g.pricelist_item.item_code %}
                                            <small class="text-muted d-block">
                                                <i class="bi bi-tag me-1"></i> {{ g.pricelist_item.item_code }}
                                            </small>
                                        {% endif %}
                                    </div>
                                </td>
                                <td class="align-middle text-center">
                                    {% if item.length %}
                                        <span class="badge bg-info fs-6">{{ item.length|floatformat:2 }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="align-middle text-center">
                                    {% if item.width %}
                                        <span class="badge bg-info fs-6">{{ item.width|floatformat:2 }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="align-middle text-center">
                                    {% if item.height %}
                                        <span class="badge bg-info fs-6">{{ item.height|floatformat:2 }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="align-middle text-center">
                                    {% if item.weight %}
                                        <span class="badge bg-primary fs-6">{{ item.weight|floatformat:2 }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="align-middle text-center fw-semibold">
                                    {% if item.count %}
                                        <span class="badge bg-success fs-6">{{ item.count|floatformat:0 }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="align-middle text-center text-success fw-bold fs-5">
                                    {% if item.item_amount %}
                                        <span class="amount-value" data-value="{{ item.item_amount }}">{{ item.item_amount|floatformat:2 }}</span>
                                    {% else %}
                                        <span class="text-muted">0.00</span>
                                    {% endif %}
                                </td>
                                <td class="align-middle">
                                    {% if item.session.session_number %}
                                        <span class="badge bg-warning text-dark">
                                            <i class="bi bi-calendar-event me-1"></i>
                                            جلسه {{ item.session.session_number }}
                                        </span>
                                        {% if item.session.session_title %}
                                            <div class="small text-muted mt-1">{{ item.session.session_title|truncatechars:30 }}</div>
                                        {% endif %}
                                    {% else %}
                                        <span class="text-muted">مستقیم</span>
                                    {% endif %}
                                </td>
                                <td class="align-middle">
                                    {% if item.session.session_date %}
                                        <span class="badge bg-secondary">{{ item.session.session_date|date:"Y/m/d" }}</span>
                                    {% else %}
                                        <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                            </tr>
                        {% empty %}
                            <tr class="item-row">
                                <td colspan="11" class="text-center py-4 text-muted">
                                    <i class="bi bi-inbox fs-3 mb-2"></i>
                                    <div>هیچ آیتمی برای این گروه ثبت نشده</div>
                                </td>
                            </tr>
                        {% endfor %}

                        <tr class="group-total">
                            <td colspan="8" class="text-start ps-4 py-2">
                                <div class="d-flex align-items-center">
                                    <i class="bi bi-calculator-fill me-2 text-white"></i>
                                    <span class="fw-bold fs-5">جمع ردیف {{ g.row_number }}</span>
                                </div>
                            </td>
                            <td class="py-2">
                                <span class="fs-4 fw-bold">{{ g.group_total|floatformat:2 }}</span>
                            </td>
                            <td colspan="2" class="text-center py-2">
                                <span class="badge bg-light text-dark fs-6 px-2 py-1">{{ g.unit }}</span>
                            </td>
                        </tr>
                    {% empty %}
                        <tr class="no-items">
                            <td colspan="11" class="text-center py-5">
                                <div class="empty-state">
                                    <i class="bi bi-ruler display-1 text-muted mb-4"></i>
                                    <h5 class="text-muted mb-3">هیچ آیتم متره‌ای یافت نشد</h5>
                                    <p class="text-muted mb-4">
                                        برای این پروژه و رشته انتخابی، آیتم متره‌ای ثبت نشده است.
                                    </p>
                                    <div class="d-flex gap-2 justify-content-center">
                                        <a href="{% url 'riz_metre_discipline_list' project.id %}" 
                                           class="btn btn-primary">
                                            <i class="bi bi-arrow-repeat me-2"></i>تغییر رشته
                                        </a>
                                        <a href="{% url 'project_financial_report' project.id %}" 
                                           class="btn btn-outline-secondary">
                                            <i class="bi bi-arrow-left me-2"></i>بازگشت
                                        </a>
                                    </div>
                                </div>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
                
                <!-- Table Footer -->
                <tfoot class="table-dark">
                    <tr>
                        <th colspan="8" class="text-end pe-4 py-3">
                            <div class="d-flex align-items-center">
                                <i class="bi bi-award-fill me-2 text-warning"></i>
                                <span class="fw-bold fs-5">جمع کل پروژه</span>
                            </div>
                        </th>
                        <th class="py-3">
                            {% with grand_total=0 %}
                                {% for group in groups %}
                                    {% with group_total=group.group_total %}
                                        {% with grand_total=grand_total|add:group_total %}
                                        {% endwith %}
                                    {% endwith %}
                                {% empty %}
                                    {% with grand_total=0 %}
                                    {% endwith %}
                                {% endfor %}
                                <span class="fs-3 fw-bold text-warning">{{ grand_total|floatformat:2 }}</span>
                            {% endwith %}
                        </th>
                        <th colspan="2" class="py-3 text-center">
                            <span class="badge bg-warning text-dark fs-5 px-3 py-2">
                                مجموع {{ groups|length }} ردیف
                            </span>
                        </th>
                    </tr>
                </tfoot>
            </table>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row mb-4">
        <div class="col-md-6">
            <div class="card card-custom h-100">
                <div class="card-header-custom">
                    <h6 class="card-title-custom">
                        <i class="bi bi-bar-chart me-2"></i>
                        خلاصه آماری
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6 border-end">
                            <div class="h5 fw-bold text-primary mb-1">{{ groups|length }}</div>
                            <small class="text-muted">تعداد گروه‌ها</small>
                        </div>
                        <div class="col-6">
                            {% with total_items=0 %}
                                {% for group in groups %}
                                    {% with group_items=group.items|length %}
                                        {% with total_items=total_items|add:group_items %}
                                        {% endwith %}
                                    {% endwith %}
                                {% empty %}
                                    {% with total_items=0 %}
                                    {% endwith %}
                                {% endfor %}
                                <div class="h5 fw-bold text-success mb-1">{{ total_items }}</div>
                                <small class="text-muted">تعداد آیتم‌ها</small>
                            {% endwith %}
                        </div>
                    </div>
                    <hr class="my-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <span class="h6 fw-bold text-dark">جمع کل متره:</span>
                        <span class="h4 fw-bold text-success">
                            {% with grand_total=0 %}
                                {% for group in groups %}
                                    {% with group_total=group.group_total %}
                                        {% with grand_total=grand_total|add:group_total %}
                                        {% endwith %}
                                    {% endwith %}
                                {% empty %}
                                    {% with grand_total=0 %}
                                    {% endwith %}
                                {% endfor %}
                                {{ grand_total|floatformat:2 }}
                            {% endwith %}
                        </span>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-md-6">
            <div class="card card-custom h-100">
                <div class="card-header-custom">
                    <h6 class="card-title-custom">
                        <i class="bi bi-info-circle me-2"></i>
                        اطلاعات پروژه
                    </h6>
                </div>
                <div class="card-body">
                    <div class="project-info-list">
                        <div class="info-item mb-3">
                            <div class="info-label"><i class="bi bi-geo-alt me-1"></i>موقعیت:</div>
                            <div class="info-value">{{ project.location|default:"مشخص نشده" }}</div>
                        </div>
                        {% if project.client %}
                        <div class="info-item mb-3">
                            <div class="info-label"><i class="bi bi-person-workspace me-1"></i>کارفرما:</div>
                            <div class="info-value">{{ project.client.name }}</div>
                        </div>
                        {% endif %}
                        {% if project.contractor %}
                        <div class="info-item mb-3">
                            <div class="info-label"><i class="bi bi-tools me-1"></i>پیمانکار:</div>
                            <div class="info-value">{{ project.contractor.name }}</div>
                        </div>
                        {% endif %}
                        <div class="info-item">
                            <div class="info-label"><i class="bi bi-calendar-check me-1"></i>وضعیت:</div>
                            <div class="info-value">
                                {% if project.is_completed %}
                                    <span class="badge bg-success">تکمیل شده</span>
                                {% elif project.is_active %}
                                    <span class="badge bg-warning">در حال اجرا</span>
                                {% else %}
                                    <span class="badge bg-secondary">متوقف</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Information Section -->
    <div class="alert alert-info alert-custom mb-0 no-print">
        <div class="d-flex align-items-start">
            <i class="bi bi-info-circle-fill fs-4 me-3 mt-1 text-primary flex-shrink-0"></i>
            <div>
                <h6 class="alert-heading mb-2">
                    <i class="bi bi-lightbulb me-1"></i>
                    راهنمای استفاده از گزارش
                </h6>
                <ul class="mb-0">
                    <li class="mb-2">
                        <strong>گروه‌های متره:</strong> هر ردیف از جدول، یک آیتم از فهرست‌بها را نشان می‌دهد که شامل تمام مشخصات متره‌ای آن است.
                    </li>
                    <li class="mb-2">
                        <strong>مقادیر:</strong> ستون "مقدار" حاصل‌ضرب ابعاد و تعداد است. برای مشاهده محاسبات دقیق، روی هر ردیف کلیک کنید.
                    </li>
                    <li class="mb-2">
                        <strong>صورت جلسه:</strong> آیتم‌هایی که از جلسات منشعب شده‌اند، شماره جلسه مبدا را نمایش می‌دهند.
                    </li>
                    <li>
                        <strong>صدور گزارش:</strong> از دکمه‌های صدور PDF و Excel برای تهیه گزارش رسمی استفاده کنید.
                    </li>
                </ul>
                <div class="mt-3 pt-2 border-top">
                    <small class="text-muted">
                        <i class="bi bi-clock-history me-1"></i>
                        این گزارش در {{ now|date:"Y/m/d H:i" }} تهیه شده است.
                        {% if user.is_authenticated %}
                            <span class="ms-2">| تهیه‌کننده: {{ user.get_full_name|default:user.username }}</span>
                        {% endif %}
                    </small>
                </div>
            </div>
        </div>
    </div>

</div>

<!-- Search Modal -->
<div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="searchModalLabel">
                    <i class="bi bi-search me-2"></i>جستجو در آیتم‌های متره
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <span class="input-group-text">
                        <i class="bi bi-search text-muted"></i>
                    </span>
                    <input type="text" class="form-control form-control-lg" id="searchInput" 
                           placeholder="شماره آیتم، شرح، یا مشخصات را جستجو کنید..." 
                           data-search-target="#measurement-table">
                    <button class="btn btn-outline-secondary" type="button" id="clearSearch">
                        <i class="bi bi-x"></i>
                    </button>
                </div>
                <div class="search-results mt-3" style="max-height: 300px; overflow-y: auto;">
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-search fs-1 mb-2"></i>
                        <div>شروع به تایپ کنید...</div>
                    </div>
                </div>
                <div class="search-stats mt-2 text-center small text-muted" id="searchStats">
                    0 نتیجه از {{ total_items|default:0 }} آیتم
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Column Toggle Modal -->
<div class="modal fade" id="columnsModal" tabindex="-1" aria-labelledby="columnsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="columnsModalLabel">
                    <i class="bi bi-columns-gap me-2"></i>تنظیم ستون‌ها
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="column-settings">
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="col-length" checked>
                        <label class="form-check-label" for="col-length">
                            طول
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="col-width" checked>
                        <label class="form-check-label" for="col-width">
                            عرض
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="col-height" checked>
                        <label class="form-check-label" for="col-height">
                            ارتفاع
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="col-weight" checked>
                        <label class="form-check-label" for="col-weight">
                            وزن
                        </label>
                    </div>
                    <div class="form-check mb-2">
                        <input class="form-check-input" type="checkbox" id="col-count" checked>
                        <label class="form-check-label" for="col-count">
                            تعداد
                        </label>
                    </div>
                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="col-session" checked>
                        <label class="form-check-label" for="col-session">
                            صورت جلسه
                        </label>
                    </div>
                    <div class="d-grid">
                        <button class="btn btn-primary btn-sm" id="reset-columns">بازنشانی</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="{% static 'js/riz_metre.js' %}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize tooltips
    if (typeof ProjectUtils !== 'undefined' && ProjectUtils.initTooltips) {
        ProjectUtils.initTooltips();
    }
    
    // Initialize table functionality
    if (typeof RizMetreTable !== 'undefined') {
        new RizMetreTable();
    }
    
    // Initialize export functionality
    initializeExportButtons();
    
    // Initialize search modal
    initializeSearchModal();
    
    // Add print styles
    addPrintStyles();
    
    // Track page view
    if (typeof MainApp !== 'undefined' && MainApp.logEvent) {
        MainApp.logEvent('page_view', {
            page: 'riz_metre',
            project_id: {{ project.id|default:0 }},
            discipline: '{{ discipline_label|default:"all" }}'
        });
    }

    function initializeExportButtons() {
        // PDF Export
        const pdfBtn = document.getElementById('export-pdf');
        if (pdfBtn) {
            pdfBtn.addEventListener('click', function() {
                if (typeof ProjectUtils !== 'undefined' && ProjectUtils.confirmAction) {
                    ProjectUtils.confirmAction('آیا مطمئن هستید که می‌خواهید گزارش را به فرمت PDF صادر کنید؟')
                        .then(() => {
                            // Show loading
                            const originalHTML = this.innerHTML;
                            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>در حال تهیه...';
                            this.disabled = true;
                            
                            // Create export data
                            const exportData = {
                                project_id: {{ project.id|default:0 }},
                                discipline: '{{ discipline_choice|default:"all" }}',
                                format: 'pdf',
                                include_details: true,
                                timestamp: new Date().toISOString()
                            };
                            
                            // Simple download simulation (replace with actual API call)
                            setTimeout(() => {
                                const link = document.createElement('a');
                                link.href = '#';
                                link.download = `riz-metre-report-{{ project.id }}-${new Date().toISOString().split('T')[0]}.pdf`;
                                link.style.display = 'none';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                
                                this.innerHTML = originalHTML;
                                this.disabled = false;
                                
                                if (typeof ProjectUtils !== 'undefined' && ProjectUtils.showToast) {
                                    ProjectUtils.showToast('گزارش PDF با موفقیت صادر شد', 'success');
                                }
                            }, 2000);
                        });
                }
            });
        }

        // Excel Export
        const excelBtn = document.getElementById('export-excel');
        if (excelBtn) {
            excelBtn.addEventListener('click', function() {
                if (typeof ProjectUtils !== 'undefined' && ProjectUtils.confirmAction) {
                    ProjectUtils.confirmAction('آیا مطمئن هستید که می‌خواهید گزارش را به فرمت Excel صادر کنید؟')
                        .then(() => {
                            // Show loading
                            const originalHTML = this.innerHTML;
                            this.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>در حال تهیه...';
                            this.disabled = true;
                            
                            // Create export data
                            const exportData = {
                                project_id: {{ project.id|default:0 }},
                                discipline: '{{ discipline_choice|default:"all" }}',
                                format: 'excel',
                                include_formulas: true,
                                timestamp: new Date().toISOString()
                            };
                            
                            // Simple download simulation
                            setTimeout(() => {
                                const link = document.createElement('a');
                                link.href = '#';
                                link.download = `riz-metre-report-{{ project.id }}-${new Date().toISOString().split('T')[0]}.xlsx`;
                                link.style.display = 'none';
                                document.body.appendChild(link);
                                link.click();
                                document.body.removeChild(link);
                                
                                this.innerHTML = originalHTML;
                                this.disabled = false;
                                
                                if (typeof ProjectUtils !== 'undefined' && ProjectUtils.showToast) {
                                    ProjectUtils.showToast('گزارش Excel با موفقیت صادر شد', 'success');
                                }
                            }, 2000);
                }
            });
        }
    }

    function initializeSearchModal() {
        const searchModalEl = document.getElementById('searchModal');
        const searchBtn = document.getElementById('search-table');
        if (!searchModalEl || !searchBtn) return;
        
        const searchModal = new bootstrap.Modal(searchModalEl);
        const searchInput = document.getElementById('searchInput');
        const clearSearch = document.getElementById('clearSearch');
        const searchResults = document.querySelector('.search-results');
        const searchStats = document.getElementById('searchStats');

        if (!searchInput || !clearSearch || !searchResults || !searchStats) return;

        // Open search modal
        searchBtn.addEventListener('click', () => {
            searchModal.show();
            setTimeout(() => searchInput.focus(), 300);
        });

        // Search functionality
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            const query = this.value.trim();
            
            searchTimeout = setTimeout(() => {
                if (query.length >= 2) {
                    performSearch(query);
                } else {
                    searchResults.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-search fs-1 mb-2"></i><div>شروع به تایپ کنید...</div></div>';
                    searchStats.textContent = '0 نتیجه از {{ groups|length|default:0 }} آیتم';
                }
            }, 300);
        });

        // Clear search
        clearSearch.addEventListener('click', function() {
            searchInput.value = '';
            searchInput.focus();
            searchResults.innerHTML = '<div class="text-center text-muted py-4"><i class="bi bi-search fs-1 mb-2"></i><div>شروع به تایپ کنید...</div></div>';
            searchStats.textContent = '0 نتیجه از {{ groups|length|default:0 }} آیتم';
        });

        function performSearch(query) {
            // Show loading
            searchResults.innerHTML = '<div class="text-center py-3"><div class="spinner-border spinner-border-sm text-primary me-2"></div>در حال جستجو...</div>';

            // Search in table rows
            const rows = document.querySelectorAll('#measurement-table .item-row');
            const results = [];
            let matchCount = 0;

            rows.forEach((row, index) => {
                const textContent = row.textContent.toLowerCase();
                const groupNumber = row.getAttribute('data-group') || '';
                const itemId = row.getAttribute('data-item-id') || '';
                
                // Check if matches query
                if (textContent.includes(query.toLowerCase()) || 
                    groupNumber.includes(query) || 
                    itemId.includes(query)) {
                    
                    matchCount++;
                    const description = row.querySelector('.item-description')?.textContent.trim() || 
                                      row.cells[2]?.textContent.trim() || 'آیتم';
                    
                    results.push({
                        group: groupNumber,
                        description: description.substring(0, 80) + (description.length > 80 ? '...' : ''),
                        amount: row.querySelector('.amount-value')?.textContent || '0.00',
                        index: index + 1,
                        row: row
                    });
                }
            });

            // Display results
            if (results.length > 0) {
                const resultsHTML = results.map((result, idx) => `
                    <div class="search-result p-3 border-bottom hoverable" 
                         data-result-index="${result.index}" 
                         style="cursor: pointer;">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1 me-3">
                                <div class="fw-semibold text-primary mb-1">${result.description}</div>
                                <div class="small text-muted">
                                    <i class="bi bi-tag me-1"></i>ردیف ${result.group} 
                                    | <i class="bi bi-calculator me-1"></i>${result.amount}
                                </div>
                            </div>
                            <div class="text-end">
                                <span class="badge bg-secondary fs-6">${idx + 1}</span>
                            </div>
                        </div>
                    </div>
                `).join('');

                searchResults.innerHTML = resultsHTML;
                
                // Add click handlers
                document.querySelectorAll('.search-result').forEach(result => {
                    result.addEventListener('click', function() {
                        const rowIndex = parseInt(this.getAttribute('data-result-index'));
                        const targetRow = rows[rowIndex - 1];
                        
                        if (targetRow) {
                            // Scroll to row
                            targetRow.scrollIntoView({ 
                                behavior: 'smooth', 
                                block: 'center' 
                            });
                            
                            // Highlight row
                            document.querySelectorAll('.item-row').forEach(r => {
                                r.classList.remove('table-highlight');
                            });
                            targetRow.classList.add('table-highlight');
                            
                            // Close modal
                            searchModal.hide();
                            
                            // Show toast if available
                            if (typeof ProjectUtils !== 'undefined' && ProjectUtils.showToast) {
                                ProjectUtils.showToast(`رفتن به ردیف ${result.group}، آیتم ${rowIndex}`, 'info');
                            }
                        }
                    });
                });

                searchStats.innerHTML = `
                    <i class="bi bi-check-circle text-success me-1"></i>
                    ${matchCount} نتیجه از ${rows.length} آیتم
                `;
            } else {
                searchResults.innerHTML = `
                    <div class="text-center text-muted py-4">
                        <i class="bi bi-search fs-1 mb-3 opacity-50"></i>
                        <div class="h6 mb-2">هیچ نتیجه‌ای یافت نشد</div>
                        <small class="opacity-75">"${query}"</small>
                        <div class="mt-3">
                            <button class="btn btn-outline-secondary btn-sm" onclick="window.location.reload()">
                                <i class="bi bi-arrow-clockwise me-1"></i>تلاش مجدد
                            </button>
                        </div>
                    </div>
                `;
                searchStats.innerHTML = `
                    <i class="bi bi-x-circle text-danger me-1"></i>
                    0 نتیجه از ${rows.length} آیتم
                `;
            }
        }
    }

    function addPrintStyles() {
        if (!document.getElementById('print-styles-riz-metre')) {
            const style = document.createElement('style');
            style.id = 'print-styles-riz-metre';
            style.textContent = `
                @media print {
                    .no-print { display: none !important; }
                    .container-fluid { padding: 0 !important; }
                    .riz-metre-header { 
                        background: #ffffff !important; 
                        color: #000 !important; 
                        border: 1px solid #dee2e6 !important;
                        break-inside: avoid;
                    }
                    .measurement-table { 
                        box-shadow: none !important; 
                        border: 2px solid #000 !important; 
                        break-inside: avoid;
                    }
                    .table { 
                        font-size: 10pt !important; 
                        margin-bottom: 0 !important; 
                        width: 100% !important;
                    }
                    .table th, .table td { 
                        border: 1px solid #000 !important; 
                        padding: 0.5rem !important; 
                        vertical-align: middle !important;
                    }
                    .group-header, .group-total { 
                        background: #e9ecef !important; 
                        color: #000 !important; 
                        font-weight: bold !important;
                    }
                    .item-row:hover { background: transparent !important; }
                    .stats-grid { display: none !important; }
                    .breadcrumb { display: none !important; }
                    .page-break { page-break-before: always; }
                }
                
                @page {
                    margin: 1in;
                    size: A4 landscape;
                }
            `;
            document.head.appendChild(style);
        }
    }

    // Keyboard shortcuts for this page
    document.addEventListener('keydown', function(e) {
        // Ctrl+P for print
        if (e.ctrlKey && e.key === 'p') {
            e.preventDefault();
            window.print();
        }
        
        // Ctrl+F for search
        if (e.ctrlKey && e.key === 'f') {
            e.preventDefault();
            const searchBtn = document.getElementById('search-table');
            if (searchBtn) {
                searchBtn.click();
            }
        }
        
        // Esc to close modals
        if (e.key === 'Escape') {
            const modals = document.querySelectorAll('.modal.show');
            modals.forEach(modal => {
                const modalInstance = bootstrap.Modal.getInstance(modal);
                if (modalInstance) {
                    modalInstance.hide();
                }
            });
        }
    });

    // Track user interactions
    document.addEventListener('click', function(e) {
        if (e.target.closest('.item-row')) {
            const row = e.target.closest('.item-row');
            const itemId = row.getAttribute('data-item-id');
            if (itemId && typeof MainApp !== 'undefined' && MainApp.logEvent) {
                MainApp.logEvent('item_clicked', {
                    item_id: itemId,
                    group: row.getAttribute('data-group'),
                    action: 'view_details'
                });
            }
        }
    });
});

// Global functions for inline event handlers
function downloadReport(format) {
    const button = document.getElementById(format === 'pdf' ? 'export-pdf' : 'export-excel');
    if (button) {
        button.click();
    }
}
</script>
{% endblock %}
