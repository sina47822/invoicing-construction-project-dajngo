<!-- templates/projects/project_create.html -->
{% extends 'layout/project_base.html' %}
{% load static %}

{% block title %}Ø§ÛŒØ¬Ø§Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯{% endblock %}

{% block content %}
<div class="container-fluid">
    
    <!-- Messages -->
    {% if messages %}
    <div class="row mb-4">
        <div class="col-12">
            {% for message in messages %}
            <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                <i class="bi {% if message.tags == 'success' %}bi-check-circle text-success{% elif message.tags == 'error' %}bi-exclamation-triangle text-danger{% elif message.tags == 'warning' %}bi-exclamation-triangle text-warning{% else %}bi-info-circle text-info{% endif %} me-2"></i>
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb" class="d-none d-md-block">
                <ol class="breadcrumb breadcrumb-light">
                    <li class="breadcrumb-item">
                        <a href="{% url 'projects:project_list' %}">
                            <i class="bi bi-buildings me-1"></i>Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§
                        </a>
                    </li>
                    <li class="breadcrumb-item active" aria-current="page">Ø³Ø§Ø®Øª Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯</li>
                </ol>
            </nav>
            <h2 class="mb-1">
                <i class="bi bi-plus-circle text-primary me-2"></i>
                Ø³Ø§Ø®Øª Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯
            </h2>
            <p class="text-muted mb-0">
                <small>Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</small>
            </p>
        </div>
        
        <div class="d-flex gap-2">
            <!-- Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ø¯Ú©Ù…Ù‡ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† -->
            <a href="{% url 'accounts:user_list' %}" 
            class="btn btn-outline-info">
                <i class="bi bi-people me-2"></i>Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
            </a>
            <a href="{% url 'projects:project_list' %}" 
            class="btn btn-outline-secondary">
                <i class="bi bi-arrow-right me-2"></i>Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª Ù¾Ø±ÙˆÚ˜Ù‡â€ŒÙ‡Ø§
            </a>
        </div>
    </div>

    <!-- ÙØ±Ù… Ø³Ø§Ø®Øª Ù¾Ø±ÙˆÚ˜Ù‡ -->
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <div class="card border-0 shadow-lg">
                <div class="card-header bg-primary border-0">
                    <h5 class="card-title mb-0 text-white">
                        <i class="bi bi-plus-circle text-white me-2"></i>
                        Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù¾Ø±ÙˆÚ˜Ù‡ Ø¬Ø¯ÛŒØ¯
                    </h5>
                </div>
                
                <div class="card-body p-4">
                    <form method="POST" id="projectCreateForm" enctype="multipart/form-data" novalidate>
                        {% csrf_token %}
                        
                        <!-- Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ú©Ù„ÛŒ -->
                        {% if form.non_field_errors %}
                            <div class="alert alert-danger alert-dismissible fade show" role="alert">
                                <i class="bi bi-exclamation-triangle me-2"></i>
                                {{ form.non_field_errors }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                            </div>
                        {% endif %}
                        
                        <div class="row g-4">
                            <!-- Ø±Ø¯ÛŒÙ Ø§ÙˆÙ„: Ù†Ø§Ù… Ùˆ Ú©Ø¯ Ù¾Ø±ÙˆÚ˜Ù‡ -->
                            <div class="col-md-8">
                                <div class="form-floating">
                                    {{ form.project_name }}
                                    <label for="{{ form.project_name.id_for_label }}">
                                        {{ form.project_name.label }} <span class="text-danger">*</span>
                                    </label>
                                    {% if form.project_name.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.project_name.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="form-text">Ù†Ø§Ù… Ú©Ø§Ù…Ù„ Ù¾Ø±ÙˆÚ˜Ù‡</div>
                            </div>
                            
                            <div class="col-md-4">
                                <div class="form-floating">
                                    {{ form.project_code }}
                                    <label for="{{ form.project_code.id_for_label }}">
                                        {{ form.project_code.label }} <span class="text-danger">*</span>
                                    </label>
                                    {% if form.project_code.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.project_code.errors.0 }}
                                        </div>
                                    {% endif %}
                                </div>
                                <div class="form-text">Ù…Ø«Ø§Ù„: P-1403-001</div>
                            </div>
                            
                            <!-- Ø±Ø¯ÛŒÙ Ø¯ÙˆÙ…: Ø³Ø§Ù„ Ø§Ø¬Ø±Ø§ Ùˆ ØªØ§Ø±ÛŒØ® Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ -->
                            <div class="col-md-6">
                                <label for="{{ form.execution_year.id_for_label }}" class="form-label fw-semibold">
                                    {{ form.execution_year.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.execution_year }}
                                {% if form.execution_year.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.execution_year.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">Ø³Ø§Ù„ Ø§Ø¬Ø±Ø§ Ø¨Ø± Ø§Ø³Ø§Ø³ ØµÙˆØ±Øª ÙˆØ¶Ø¹ÛŒØª</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.contract_date.id_for_label }}" class="form-label fw-semibold">
                                    {{ form.contract_date.label }} <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    {{ form.contract_date }}
                                    <span class="input-group-text bg-primary text-white cursor-pointer" id="calendarTrigger">
                                        <i class="bi bi-calendar3"></i>
                                    </span>
                                </div>
                                {% if form.contract_date.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.contract_date.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">ÙØ±Ù…Øª: 1403/06/15</div>
                            </div>
                            
                            <!-- Ø±Ø¯ÛŒÙ Ø³ÙˆÙ…: Ù†ÙˆØ¹ Ù¾Ø±ÙˆÚ˜Ù‡ Ùˆ Ù…Ø¨Ù„Øº -->
                            <div class="col-md-6">
                                <label for="{{ form.project_type.id_for_label }}" class="form-label fw-semibold">
                                    {{ form.project_type.label }}
                                </label>
                                {{ form.project_type }}
                                {% if form.project_type.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.project_type.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">Ù†ÙˆØ¹ Ù¾Ø±ÙˆÚ˜Ù‡ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="{{ form.status.id_for_label }}" class="form-label fw-semibold">
                                    {{ form.status.label }}
                                </label>
                                {{ form.status }}
                                {% if form.status.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.status.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">ÙˆØ¶Ø¹ÛŒØª ÙØ¹Ù„ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡</div>
                            </div>
                            <!-- Ø±Ø¯ÛŒÙ Ù¾Ù†Ø¬Ù…: Ø´Ù…Ø§Ø±Ù‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ùˆ ÙˆØ¶Ø¹ÛŒØª -->
                            <div class="col-md-4">
                                    <label for="{{ form.contract_number.id_for_label }}" class="form-label fw-semibold">
                                        {{ form.contract_number.label }} <span class="text-danger">*</span>
                                    </label>
                                    {{ form.contract_number }}
                                    {% if form.contract_number.errors %}
                                        <div class="invalid-feedback d-block">
                                            {{ form.contract_number.errors.0 }}
                                        </div>
                                    {% endif %}
                                <div class="form-text">Ù…Ø«Ø§Ù„: 1403/001</div>
                            </div>
                        
                            <div class="col-md-4">
                                <label for="{{ form.contract_amount.id_for_label }}" class="form-label fw-semibold">
                                    {{ form.contract_amount.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.contract_amount }}
                                {% if form.contract_amount.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.contract_amount.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">Ø¨Ù‡ Ø±ÛŒØ§Ù„ - Ù…Ø«Ø§Ù„: 1,500,000,000</div>
                            </div>
                            
                            <div class="col-md-4">
                                <label for="{{ form.vat_percentage.id_for_label }}" class="form-label fw-semibold">
                                    {{ form.vat_percentage.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.vat_percentage }}
                                {% if form.vat_percentage.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.vat_percentage.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text"> - Ù…Ø«Ø§Ù„: Ù…Ø§Ù„ÛŒØ§Øª Ø¨Ø± Ø§Ø±Ø²Ø´ Ø§ÙØ²ÙˆØ¯Ù‡ 10%</div>
                            </div>
                            
                            <!-- Ø±Ø¯ÛŒÙ Ú†Ù‡Ø§Ø±Ù…: Ù…ÙˆÙ‚Ø¹ÛŒØª Ø¬ØºØ±Ø§ÙÛŒØ§ÛŒÛŒ -->
                            <div class="col-md-4">
                                <label for="{{ form.country.id_for_label }}" class="form-label fw-semibold">
                                    {{ form.country.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.country }}
                                {% if form.country.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.country.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">Ú©Ø´ÙˆØ± Ù…Ø­Ù„ Ù¾Ø±ÙˆÚ˜Ù‡</div>
                            </div>

                            <div class="col-md-4">
                                <label for="{{ form.province.id_for_label }}" class="form-label fw-semibold">
                                    {{ form.province.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.province }}
                                {% if form.province.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.province.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">Ø§Ø³ØªØ§Ù† Ù…Ø­Ù„ Ø§Ø¬Ø±Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡</div>
                            </div>

                            <div class="col-md-4">
                                <label for="{{ form.city.id_for_label }}" class="form-label fw-semibold">
                                    {{ form.city.label }} <span class="text-danger">*</span>
                                </label>
                                {{ form.city }}
                                {% if form.city.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.city.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">Ø´Ù‡Ø± Ù…Ø­Ù„ Ø§Ø¬Ø±Ø§ÛŒ Ù¾Ø±ÙˆÚ˜Ù‡</div>
                            </div>
                            
                            <!-- Ø±Ø¯ÛŒÙ Ø´Ø´Ù…: ÙØ§ÛŒÙ„ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ -->
                            <div class="col-12">
                                <label for="{{ form.contract_file.id_for_label }}" class="form-label fw-semibold">
                                    {{ form.contract_file.label }}
                                </label>
                                {{ form.contract_file }}
                                {% if form.contract_file.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.contract_file.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">
                                    ÙØ§ÛŒÙ„ PDF ÛŒØ§ Word (Ø­Ø¯Ø§Ú©Ø«Ø± 5 Ù…Ú¯Ø§Ø¨Ø§ÛŒØª) - Ø§Ø®ØªÛŒØ§Ø±ÛŒ
                                    {% if project.contract_file %}
                                        <br>
                                        <a href="{{ project.contract_file.url }}" target="_blank" class="text-primary">
                                            <i class="bi bi-file-earmark-text me-1"></i>Ù…Ø´Ø§Ù‡Ø¯Ù‡ ÙØ§ÛŒÙ„ ÙØ¹Ù„ÛŒ
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                            
                            <!-- Ø±Ø¯ÛŒÙ Ù‡ÙØªÙ…: ØªÙˆØ¶ÛŒØ­Ø§Øª -->
                            <div class="col-12">
                                <label for="{{ form.description.id_for_label }}" class="form-label fw-semibold">
                                    {{ form.description.label }}
                                </label>
                                {{ form.description }}
                                {% if form.description.errors %}
                                    <div class="invalid-feedback d-block">
                                        {{ form.description.errors.0 }}
                                    </div>
                                {% endif %}
                                <div class="form-text">ØªÙˆØ¶ÛŒØ­Ø§Øª Ù…Ø®ØªØµØ± Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù¾Ø±ÙˆÚ˜Ù‡ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</div>
                            </div>

                            <!-- Ø±Ø¯ÛŒÙ Ù‡Ø´ØªÙ…: Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù¾Ø±ÙˆÚ˜Ù‡ -->
                            <div class="col-12">
                                <div class="card border-0 bg-light">
                                    <div class="card-header bg-secondary text-white">
                                        <h6 class="card-title mb-0">
                                            <i class="bi bi-people-fill me-2"></i>
                                            Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ù¾Ø±ÙˆÚ˜Ù‡
                                        </h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="row g-3">
                                            <!-- Ú©Ø§Ø±ÙØ±Ù…Ø§ -->
                                            <div class="col-md-6">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <label for="{{ form.employer_user.id_for_label }}" class="form-label fw-semibold mb-0">
                                                        {{ form.employer_user.label }}
                                                    </label>
                                                    <button type="button" class="btn btn-sm btn-outline-info" 
                                                            data-bs-toggle="modal" data-bs-target="#createUserModal"
                                                            data-role="employer">
                                                        <i class="bi bi-person-plus me-1"></i>Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
                                                    </button>
                                                </div>
                                                {{ form.employer_user }}
                                                {% if form.employer_user.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.employer_user.errors.0 }}
                                                    </div>
                                                {% endif %}
                                                <div class="form-text">Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù†Ù‚Ø´ Ú©Ø§Ø±ÙØ±Ù…Ø§</div>
                                            </div>
                                            
                                            <!-- Ù…Ø¯ÛŒØ± Ø·Ø±Ø­ -->
                                            <div class="col-md-6">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <label for="{{ form.project_manager_user.id_for_label }}" class="form-label fw-semibold mb-0">
                                                        {{ form.project_manager_user.label }}
                                                    </label>
                                                    <button type="button" class="btn btn-sm btn-outline-info" 
                                                            data-bs-toggle="modal" data-bs-target="#createUserModal"
                                                            data-role="project_manager">
                                                        <i class="bi bi-person-plus me-1"></i>Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
                                                    </button>
                                                </div>
                                                {{ form.project_manager_user }}
                                                {% if form.project_manager_user.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.project_manager_user.errors.0 }}
                                                    </div>
                                                {% endif %}
                                                <div class="form-text">Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù†Ù‚Ø´ Ù…Ø¯ÛŒØ± Ø·Ø±Ø­</div>
                                            </div>
                                            
                                            <!-- Ù…Ø´Ø§ÙˆØ± -->
                                            <div class="col-md-6">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <label for="{{ form.consultant_user.id_for_label }}" class="form-label fw-semibold mb-0">
                                                        {{ form.consultant_user.label }}
                                                    </label>
                                                    <button type="button" class="btn btn-sm btn-outline-info" 
                                                            data-bs-toggle="modal" data-bs-target="#createUserModal"
                                                            data-role="consultant">
                                                        <i class="bi bi-person-plus me-1"></i>Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
                                                    </button>
                                                </div>
                                                {{ form.consultant_user }}
                                                {% if form.consultant_user.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.consultant_user.errors.0 }}
                                                    </div>
                                                {% endif %}
                                                <div class="form-text">Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù†Ù‚Ø´ Ù…Ø´Ø§ÙˆØ±</div>
                                            </div>
                                            
                                            <!-- Ù†Ø§Ø¸Ø± -->
                                            <div class="col-md-6">
                                                <div class="d-flex justify-content-between align-items-center mb-2">
                                                    <label for="{{ form.supervising_engineer_user.id_for_label }}" class="form-label fw-semibold mb-0">
                                                        {{ form.supervising_engineer_user.label }}
                                                    </label>
                                                    <button type="button" class="btn btn-sm btn-outline-info" 
                                                            data-bs-toggle="modal" data-bs-target="#createUserModal"
                                                            data-role="supervisor">
                                                        <i class="bi bi-person-plus me-1"></i>Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
                                                    </button>
                                                </div>
                                                {{ form.supervising_engineer_user }}
                                                {% if form.supervising_engineer_user.errors %}
                                                    <div class="invalid-feedback d-block">
                                                        {{ form.supervising_engineer_user.errors.0 }}
                                                    </div>
                                                {% endif %}
                                                <div class="form-text">Ú©Ø§Ø±Ø¨Ø± Ø¨Ø§ Ù†Ù‚Ø´ Ù†Ø§Ø¸Ø±</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ø±Ø³Ø§Ù„ -->
                        <div class="d-flex justify-content-between align-items-center mt-5 pt-3 border-top">
                            <div>
                                <small class="text-muted">
                                    ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø¨Ø§ Ø¹Ù„Ø§Ù…Øª * Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ù‡Ø³ØªÙ†Ø¯
                                </small>
                            </div>
                            
                            <div class="d-flex gap-2">
                                <a href="{% url 'projects:project_list' %}" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-right me-2"></i>Ø§Ù†ØµØ±Ø§Ù
                                </a>
                                <button type="submit" class="btn btn-success px-4" id="submitBtn">
                                    <i class="bi bi-plus-circle me-2"></i>
                                    Ø³Ø§Ø®Øª Ù¾Ø±ÙˆÚ˜Ù‡
                                    <span class="spinner-border spinner-border-sm ms-2 d-none" id="submitSpinner"></span>
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for creating new user -->
<div class="modal fade" id="createUserModal" tabindex="-1" aria-labelledby="createUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-black" id="createUserModalLabel">
                    <i class="bi bi-person-plus me-1"></i>
                    Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
                </h5>
                <button style="position: absolute; left: 20px;" type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ø³Ø±Ø§Ø³Ø±ÛŒ Ø¯Ø± Ù…ÙˆØ¯Ø§Ù„ -->
                {% if messages %}
                <div class="mb-3">
                    {% for message in messages %}
                    <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                        <i class="bi {% if message.tags == 'success' %}bi-check-circle text-success{% elif message.tags == 'error' %}bi-exclamation-triangle text-danger{% elif message.tags == 'warning' %}bi-exclamation-triangle text-warning{% else %}bi-info-circle text-info{% endif %} me-2"></i>
                        {{ message }}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- ÙØ±Ù… Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± -->
                <form id="userCreateForm" method="post" action="{% url 'accounts:user_create' %}">
                    {% csrf_token %}
                    <input type="hidden" name="role" id="id_modal_role">
                    
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle me-2"></i>
                        Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯Ù‡ Ø¨Ù‡ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø§Ø¶Ø§ÙÙ‡ Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.
                    </div>
                    
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="id_username" class="form-label">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ *</label>
                            <input type="text" class="form-control" id="id_username" name="username" required>
                            <div class="form-text">Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù…Ù†Ø­ØµØ± Ø¨Ù‡ ÙØ±Ø¯</div>
                        </div>
                        <div class="col-md-6">
                            <label for="id_email" class="form-label">Ø§ÛŒÙ…ÛŒÙ„ *</label>
                            <input type="email" class="form-control" id="id_email" name="email" required>
                        </div>
                        <div class="col-md-6">
                            <label for="id_first_name" class="form-label">Ù†Ø§Ù… *</label>
                            <input type="text" class="form-control" id="id_first_name" name="first_name" required>
                        </div>
                        <div class="col-md-6">
                            <label for="id_last_name" class="form-label">Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ *</label>
                            <input type="text" class="form-control" id="id_last_name" name="last_name" required>
                        </div>
                        <div class="col-md-6">
                            <label for="id_password1" class="form-label">Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± *</label>
                            <input type="password" class="form-control" id="id_password1" name="password1" required>
                            <div class="form-text">Ø­Ø¯Ø§Ù‚Ù„ Û¸ Ú©Ø§Ø±Ø§Ú©ØªØ±</div>
                        </div>
                        <div class="col-md-6">
                            <label for="id_password2" class="form-label">ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ± *</label>
                            <input type="password" class="form-control" id="id_password2" name="password2" required>
                        </div>
                        <div class="col-md-6">
                            <label for="id_phone_number" class="form-label">Ø´Ù…Ø§Ø±Ù‡ ØªÙ„ÙÙ†</label>
                            <input type="text" class="form-control" id="id_phone_number" name="phone_number">
                        </div>
                        <div class="col-md-6">
                            <label for="id_national_id" class="form-label">Ú©Ø¯ Ù…Ù„ÛŒ</label>
                            <input type="text" class="form-control" id="id_national_id" name="national_id">
                        </div>
                        <div class="col-md-6">
                            <label for="id_company_name" class="form-label">Ù†Ø§Ù… Ø´Ø±Ú©Øª/Ø³Ø§Ø²Ù…Ø§Ù†</label>
                            <input type="text" class="form-control" id="id_company_name" name="company_name">
                        </div>
                        <div class="col-md-6">
                            <label for="id_position" class="form-label">Ø³Ù…Øª</label>
                            <input type="text" class="form-control" id="id_position" name="position">
                        </div>
                    </div>
                    
                    <div id="formErrors" class="alert alert-danger mt-3 d-none"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Ø§Ù†ØµØ±Ø§Ù</button>
                <!-- Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† Ù„ÛŒÙ†Ú© Ø¨Ù‡ Ù„ÛŒØ³Øª Ú©Ø§Ø±Ø¨Ø±Ø§Ù† Ø¯Ø± ÙÙˆØªØ± Ù…ÙˆØ¯Ø§Ù„ -->
                <a href="{% url 'accounts:user_list' %}" class="btn btn-outline-info me-auto">
                    <i class="bi bi-people me-2"></i>Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†
                </a>
                <button type="button" class="btn btn-primary" id="submitCreateUserForm">
                    <i class="bi bi-person-plus me-2"></i>
                    Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±
                </button>
            </div>
        </div>
    </div>
</div>

<script type="application/json" id="province-cities-data">
    {{ province_cities_json|safe }}
</script>
{% endblock %}

{% block extra_css %}
<style>
.form-control, .form-select {
    border-radius: 8px;
    border: 1.5px solid #dee2e6;
    padding: 0.75rem 2rem;
}

.form-control:focus, .form-select:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13,110,253,0.15);
}

.input-group-text {
    cursor: pointer;
}

.is-invalid {
    border-color: #dc3545 !important;
}

.invalid-feedback {
    color: #dc3545;
    font-size: 0.875rem;
}

.btn-outline-info {
    background-colrgb(187, 187, 187)42f0;
    border-color: #0dcaf0;
    color: #949494;
}

/* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ */
.btn-outline-info:hover {
    background-color: #0d42f0;
    color: white;
}

/* Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø±Ø§ÛŒ Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ alert */
.alert-link {
    color: #0a58ca;
    text-decoration: underline;
}

.alert-link:hover {
    color: #0a58ca;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    console.log('ğŸš€ Starting form initialization...');
    
    // Persian Datepicker
    function initializeDatepicker() {
        const dateInput = document.querySelector('input[name="contract_date"]');
        if (!dateInput) {
            console.log('âŒ Date input not found');
            return;
        }
        
        // Check if persianDate is available
        if (typeof persianDate === 'undefined') {
            console.error('âŒ persianDate library not loaded');
            return;
        }
        
        console.log('âœ… PersianDate library loaded:', typeof persianDate);
        
        // Set today's date as default
        const today = new persianDate();
        const todayFormatted = today.format('YYYY/MM/DD');
        
        // If field is empty, set today's date
        if (!dateInput.value.trim()) {
            dateInput.value = todayFormatted;
        }
        
        // Initialize Persian Datepicker
        $(dateInput).persianDatepicker({
            format: 'YYYY/MM/DD',
            initialValue: true,
            initialValueType: 'persian',
            autoClose: true,
            position: "auto",
            observer: true,
            calendar: {
                persian: {
                    locale: 'fa',
                    showHint: true,
                }
            },
            onSelect: function(unixDate) {
                const selectedDate = new persianDate(unixDate);
                const formattedDate = selectedDate.format('YYYY/MM/DD');
                console.log('ğŸ“… Selected date:', formattedDate);
                dateInput.value = formattedDate;
                dateInput.classList.remove('is-invalid');
            }
        });
        
        // Trigger calendar from icon
        const calendarTrigger = document.getElementById('calendarTrigger');
        if (calendarTrigger) {
            calendarTrigger.addEventListener('click', function() {
                $(dateInput).persianDatepicker('show');
            });
        }
        
        console.log('âœ… Persian Datepicker initialized');
    }
        
    // Province and City Handling
    function initializeLocationFields() {
        const provinceSelect = document.getElementById('id_province');
        const citySelect = document.getElementById('id_city');
        const countrySelect = document.getElementById('id_country');
        
        if (!provinceSelect || !citySelect || !countrySelect) return;
        
        const citiesDataElement = document.getElementById('province-cities-data');
        let citiesByProvince = {};
        
        if (citiesDataElement) {
            try {
                citiesByProvince = JSON.parse(citiesDataElement.textContent);
            } catch (e) {
                console.error('Error parsing cities data:', e);
                return;
            }
        }
        
        function updateCities() {
            const selectedProvince = provinceSelect.value;
            citySelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø±</option>';
            citySelect.disabled = true;
            
            if (selectedProvince && citiesByProvince[selectedProvince]) {
                const cities = citiesByProvince[selectedProvince];
                cities.forEach(function(city) {
                    const option = document.createElement('option');
                    option.value = city[0];  // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…Ù‚Ø¯Ø§Ø± Ø§ÙˆÙ„ (Ù…Ù‚Ø¯Ø§Ø± Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯Ù‡)
                    option.textContent = city[1];  // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù…Ù‚Ø¯Ø§Ø± Ø¯ÙˆÙ… (Ù†Ù…Ø§ÛŒØ´ÛŒ)
                    citySelect.appendChild(option);
                });
                citySelect.disabled = false;
            }
        }
        
        provinceSelect.addEventListener('change', function() {
            this.classList.remove('is-invalid');
            updateCities();
        });
        
        citySelect.addEventListener('change', function() {
            this.classList.remove('is-invalid');
        });
        
        // Initialize cities if province is already selected
        if (provinceSelect.value) {
            updateCities();
        }
    }

    // Form Validation
    function initializeFormValidation() {
        const form = document.getElementById('projectCreateForm');
        if (!form) return;
        
        form.addEventListener('submit', function(e) {
            console.log('ğŸ“¤ Form submission started...');
            
            let isValid = true;
            
            // Validate required fields
            const requiredFields = form.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                if (!field.value.trim()) {
                    field.classList.add('is-invalid');
                    isValid = false;
                }
            });
            
            // Validate province and city
            const provinceSelect = document.getElementById('id_province');
            const citySelect = document.getElementById('id_city');
            
            if (!provinceSelect.value) {
                provinceSelect.classList.add('is-invalid');
                isValid = false;
            }
            
            if (!citySelect.disabled && !citySelect.value) {
                citySelect.classList.add('is-invalid');
                isValid = false;
            }
            
            if (!isValid) {
                e.preventDefault();
                // Scroll to first error
                const firstError = form.querySelector('.is-invalid');
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    firstError.focus();
                }
            } else {
                // Show loading spinner
                const submitBtn = document.getElementById('submitBtn');
                const submitSpinner = document.getElementById('submitSpinner');
                if (submitBtn && submitSpinner) {
                    submitBtn.disabled = true;
                    submitSpinner.classList.remove('d-none');
                    submitBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®Øª Ù¾Ø±ÙˆÚ˜Ù‡...';
                }
            }
        });
    }

    // Ù…Ø¯ÛŒØ±ÛŒØª Ù…ÙˆØ¯Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± - Ù†Ø³Ø®Ù‡ Ø³Ø§Ø¯Ù‡â€ŒØªØ±
    function initializeUserCreationModal() {
        const createUserModal = document.getElementById('createUserModal');
        if (!createUserModal) {
            console.log('âŒ createUserModal not found');
            return;
        }
        
        console.log('âœ… User creation modal found');
        
        // Ù†Ù‚Ø´ Ø¨Ù‡ ÙÛŒÙ„Ø¯ mapping
        const roleToFieldMap = {
            'employer': 'employer_user',
            'project_manager': 'project_manager_user', 
            'consultant': 'consultant_user',
            'supervisor': 'supervising_engineer_user'
        };
        
        // Ù‡Ù†Ú¯Ø§Ù…ÛŒ Ú©Ù‡ Ù…ÙˆØ¯Ø§Ù„ Ø¨Ø§Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯
        createUserModal.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const role = button.getAttribute('data-role');
            
            console.log('ğŸ¯ Opening modal for role:', role);
            
            // ØªÙ†Ø¸ÛŒÙ… Ù†Ù‚Ø´ Ø¯Ø± Ù…ÙˆØ¯Ø§Ù„
            const roleInput = document.getElementById('id_modal_role');
            if (roleInput) {
                roleInput.value = role;
                console.log('âœ… Set role input to:', role);
            }
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† ÙØ±Ù…
            const form = document.getElementById('userCreateForm');
            if (form) {
                form.reset();
            }
            
            // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø®Ø·Ø§Ù‡Ø§
            const errorDiv = document.getElementById('formErrors');
            if (errorDiv) {
                errorDiv.classList.add('d-none');
                errorDiv.innerHTML = '';
            }
        });
        
        // Ø§Ø±Ø³Ø§Ù„ ÙØ±Ù… Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±
        const userCreateForm = document.getElementById('userCreateForm');
        const submitUserBtn = document.getElementById('submitCreateUserForm');
        
        if (userCreateForm && submitUserBtn) {
            submitUserBtn.addEventListener('click', function(e) {
                e.preventDefault();
                console.log('ğŸ“¤ Submitting user creation form...');
                
                const originalText = submitUserBtn.innerHTML;
                submitUserBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Ø¯Ø± Ø­Ø§Ù„ Ø§ÛŒØ¬Ø§Ø¯...';
                submitUserBtn.disabled = true;
                
                const formData = new FormData(userCreateForm);
                
                fetch(userCreateForm.action, {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest',
                        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('âœ… User creation response:', data);
                    if (data.success) {
                        // Ø¨Ø³ØªÙ† Ù…ÙˆØ¯Ø§Ù„
                        const modal = bootstrap.Modal.getInstance(createUserModal);
                        modal.hide();
                        
                        // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
                        showToast('success', 'Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯.');
                        
                        // Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ select Ù…Ø±Ø¨ÙˆØ·Ù‡
                        const role = document.getElementById('id_modal_role').value;
                        addUserToSelect(role, data.user_id, data.full_name || data.username);
                    } else {
                        // Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§Ù‡Ø§
                        showFormErrors(data.errors);
                    }
                })
                .catch(error => {
                    console.error('âŒ Error creating user:', error);
                    showToast('error', 'Ø®Ø·Ø§ Ø¯Ø± Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø±. Ù„Ø·ÙØ§Ù‹ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†ÛŒØ¯.');
                })
                .finally(() => {
                    submitUserBtn.innerHTML = originalText;
                    submitUserBtn.disabled = false;
                });
            });
        }

        // Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§Ù‡Ø§ÛŒ ÙØ±Ù…
        function showFormErrors(errors) {
            const errorDiv = document.getElementById('formErrors');
            if (!errorDiv) {
                // Ø§Ú¯Ø± errorDiv ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø§ÛŒØ¬Ø§Ø¯Ø´ Ú©Ù†
                const modalBody = document.querySelector('#createUserModal .modal-body');
                const newErrorDiv = document.createElement('div');
                newErrorDiv.id = 'formErrors';
                newErrorDiv.className = 'alert alert-danger mt-3';
                modalBody.appendChild(newErrorDiv);
            }
            
            const errorDivFinal = document.getElementById('formErrors');
            let errorHtml = '<strong>Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø® Ø¯Ø§Ø¯Ù‡ Ø§Ø³Øª:</strong><ul class="mb-0 mt-2">';
            
            if (typeof errors === 'object') {
                for (const field in errors) {
                    if (errors.hasOwnProperty(field)) {
                        const fieldErrors = Array.isArray(errors[field]) ? errors[field] : [errors[field]];
                        fieldErrors.forEach(error => {
                            errorHtml += `<li>${error}</li>`;
                        });
                    }
                }
            } else if (typeof errors === 'string') {
                errorHtml += `<li>${errors}</li>`;
            }
            
            errorHtml += '</ul>';
            
            errorDivFinal.innerHTML = errorHtml;
            errorDivFinal.classList.remove('d-none');
            
            // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ø¨Ø§Ù„Ø§ÛŒ Ø®Ø·Ø§Ù‡Ø§
            errorDivFinal.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø¨Ù‡ select
        function addUserToSelect(role, userId, userName) {
            const fieldName = roleToFieldMap[role];
            if (!fieldName) {
                console.error('âŒ Unknown role:', role);
                return;
            }
            
            const selectId = `id_${fieldName}`;
            const selectElement = document.getElementById(selectId);
            
            if (selectElement) {
                console.log('â• Adding user to select:', selectId, userId, userName);
                
                // Ø­Ø°Ù Ú¯Ø²ÛŒÙ†Ù‡ Ø®Ø§Ù„ÛŒ Ø§Ú¯Ø± ÙˆØ¬ÙˆØ¯ Ø¯Ø§Ø±Ø¯
                const emptyOption = selectElement.querySelector('option[value=""]');
                if (emptyOption) {
                    emptyOption.remove();
                }
                
                // Ø¨Ø±Ø±Ø³ÛŒ ÙˆØ¬ÙˆØ¯ Ú©Ø§Ø±Ø¨Ø± Ø¯Ø± Ù„ÛŒØ³Øª
                const existingOption = selectElement.querySelector(`option[value="${userId}"]`);
                if (!existingOption) {
                    // Ø§ÙØ²ÙˆØ¯Ù† Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
                    const newOption = document.createElement('option');
                    newOption.value = userId;
                    newOption.textContent = userName;
                    selectElement.appendChild(newOption);
                }
                
                // Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯
                selectElement.value = userId;
                
                // Ù†Ù…Ø§ÛŒØ´ Ù…ÙˆÙÙ‚ÛŒØª
                showToast('success', `Ú©Ø§Ø±Ø¨Ø± "${userName}" Ø¨Ù‡ Ù„ÛŒØ³Øª Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯`);
            } else {
                console.error('âŒ Select element not found:', selectId);
            }
        }
    }

    // Ù†Ù…Ø§ÛŒØ´ Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† - Ù†Ø³Ø®Ù‡ Ø³Ø§Ø¯Ù‡
    function showToast(type, message) {
        // Ø§ÛŒØ¬Ø§Ø¯ ÛŒÚ© Ù†ÙˆØªÛŒÙÛŒÚ©ÛŒØ´Ù† Ø³Ø§Ø¯Ù‡
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        toast.innerHTML = `
            <i class="bi ${type === 'success' ? 'bi-check-circle' : 'bi-exclamation-triangle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        document.body.appendChild(toast);
        
        // Ø­Ø°Ù Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ø¹Ø¯ Ø§Ø² 5 Ø«Ø§Ù†ÛŒÙ‡
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 5000);
    }

    // Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§Ù‡Ø§ÛŒ ÙØ±Ù…
    function showFormErrors(errors) {
        const errorDiv = document.getElementById('formErrors');
        if (!errorDiv) {
            // Ø§Ú¯Ø± errorDiv ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø§ÛŒØ¬Ø§Ø¯Ø´ Ú©Ù†
            const modalBody = document.querySelector('#createUserModal .modal-body');
            const newErrorDiv = document.createElement('div');
            newErrorDiv.id = 'formErrors';
            newErrorDiv.className = 'alert alert-danger mt-3';
            modalBody.appendChild(newErrorDiv);
        }
        
        const errorDivFinal = document.getElementById('formErrors');
        let errorHtml = '';
        
        if (errors.permission) {
            // Ø®Ø·Ø§ÛŒ Ù…Ø¬ÙˆØ² - Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… ÙˆØ§Ø¶Ø­
            errorHtml = `
                <div class="alert alert-warning">
                    <i class="bi bi-shield-exclamation me-2"></i>
                    <strong>Ù…Ø´Ú©Ù„ Ø¯Ø³ØªØ±Ø³ÛŒ:</strong>
                    <p class="mb-0 mt-2">${errors.permission.join(', ')}</p>
                    <small class="d-block mt-2">
                        Ø¨Ø±Ø§ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ØŒ Ø¨Ø§ÛŒØ¯ Ù†Ù‚Ø´ "Ù¾ÛŒÙ…Ø§Ù†Ú©Ø§Ø±" ÛŒØ§ "Ø§Ø¯Ù…ÛŒÙ†" Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´ÛŒØ¯.
                        <a href="{% url 'accounts:user_list' %}" class="alert-link">Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ø§Ø±Ø¨Ø±Ø§Ù†</a>
                    </small>
                </div>
            `;
        } else {
            // Ø®Ø·Ø§Ù‡Ø§ÛŒ Ù…Ø¹Ù…ÙˆÙ„ ÙØ±Ù…
            errorHtml = '<strong>Ù„Ø·ÙØ§Ù‹ Ø®Ø·Ø§Ù‡Ø§ÛŒ Ø²ÛŒØ± Ø±Ø§ Ø§ØµÙ„Ø§Ø­ Ú©Ù†ÛŒØ¯:</strong><ul class="mb-0 mt-2">';
            
            if (typeof errors === 'object') {
                for (const field in errors) {
                    if (errors.hasOwnProperty(field)) {
                        const fieldErrors = Array.isArray(errors[field]) ? errors[field] : [errors[field]];
                        fieldErrors.forEach(error => {
                            // Ù†Ù…Ø§ÛŒØ´ Ù†Ø§Ù… ÙÛŒÙ„Ø¯ Ø¨Ù‡ ÙØ§Ø±Ø³ÛŒ
                            const fieldNames = {
                                'username': 'Ù†Ø§Ù… Ú©Ø§Ø±Ø¨Ø±ÛŒ',
                                'email': 'Ø§ÛŒÙ…ÛŒÙ„', 
                                'first_name': 'Ù†Ø§Ù…',
                                'last_name': 'Ù†Ø§Ù… Ø®Ø§Ù†ÙˆØ§Ø¯Ú¯ÛŒ',
                                'password1': 'Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±',
                                'password2': 'ØªÚ©Ø±Ø§Ø± Ø±Ù…Ø² Ø¹Ø¨ÙˆØ±',
                                'role': 'Ù†Ù‚Ø´',
                                'general': 'Ø¹Ù…ÙˆÙ…ÛŒ',
                                '__all__': 'Ø®Ø·Ø§ÛŒ Ú©Ù„ÛŒ'
                            };
                            const fieldName = fieldNames[field] || field;
                            errorHtml += `<li><strong>${fieldName}:</strong> ${error}</li>`;
                        });
                    }
                }
            } else if (typeof errors === 'string') {
                errorHtml += `<li>${errors}</li>`;
            }
            
            errorHtml += '</ul>';
        }
        
        errorDivFinal.innerHTML = errorHtml;
        errorDivFinal.classList.remove('d-none');
        
        // Ø§Ø³Ú©Ø±ÙˆÙ„ Ø¨Ù‡ Ø¨Ø§Ù„Ø§ÛŒ Ø®Ø·Ø§Ù‡Ø§
        errorDivFinal.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }
    // Initialize everything
    initializeDatepicker();
    initializeLocationFields();
    initializeFormValidation();
    initializeUserCreationModal();
    showToast();
    showFormErrors();
    console.log('ğŸ‰ Form initialization completed!');
});
</script>
{% endblock %}